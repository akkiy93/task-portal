<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .header h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 2rem;
    }
    
    .workload-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .workload-card h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }
    
    .workload-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: #333;
    }
    
    .stat-value.high {
      color: #e74c3c;
    }
    
    .stat-value.medium {
      color: #f39c12;
    }
    
    .stat-value.low {
      color: #27ae60;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.9rem;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }
    
    .task-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .form-group label {
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .task-list {
      max-height: 600px;
      overflow-y: auto;
    }
    
    .task-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
      transition: transform 0.2s;
    }
    
    .task-item:hover {
      transform: translateX(5px);
    }
    
    .task-item.priority-high {
      border-left-color: #e74c3c;
    }
    
    .task-item.priority-medium {
      border-left-color: #f39c12;
    }
    
    .task-item.priority-low {
      border-left-color: #27ae60;
    }
    
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }
    
    .task-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: #333;
    }
    
    .task-meta {
      display: flex;
      gap: 10px;
      font-size: 0.85rem;
      color: #666;
    }
    
    .task-description {
      color: #555;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge-priority-high {
      background: #fee;
      color: #e74c3c;
    }
    
    .badge-priority-medium {
      background: #fff4e6;
      color: #f39c12;
    }
    
    .badge-priority-low {
      background: #e8f5e9;
      color: #27ae60;
    }
    
    .badge-hours {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    .error {
      background: #fee;
      color: #e74c3c;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .calendar-events {
      margin-top: 15px;
    }
    
    .calendar-event {
      background: #f0f4ff;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    .calendar-event-title {
      font-weight: 600;
      color: #667eea;
    }
    
    .calendar-event-time {
      color: #666;
      font-size: 0.85rem;
      margin-top: 4px;
    }
    
    .task-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    
    .btn-edit, .btn-delete {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-edit {
      background: #667eea;
      color: white;
    }
    
    .btn-edit:hover {
      background: #5568d3;
    }
    
    .btn-delete {
      background: #e74c3c;
      color: white;
    }
    
    .btn-delete:hover {
      background: #c0392b;
    }
    
    .task-status-select {
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
    }
    
    .badge-status-completed {
      background: #e8f5e9;
      color: #27ae60;
    }
    
    .badge-status-in-progress {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .badge-status-cancelled {
      background: #f5f5f5;
      color: #666;
    }
    
    .badge-status-pending {
      background: #fff4e6;
      color: #f39c12;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      color: #667eea;
      margin: 0;
    }
    
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: #000;
    }
    
    .health-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .health-score-buttons {
      display: flex;
      gap: 10px;
    }
    
    .health-score-btn {
      flex: 1;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .health-score-btn:hover {
      border-color: #667eea;
    }
    
    .health-score-btn.selected {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .health-score-btn.good {
      border-color: #27ae60;
    }
    
    .health-score-btn.good.selected {
      background: #27ae60;
      border-color: #27ae60;
    }
    
    .health-score-btn.bad {
      border-color: #e74c3c;
    }
    
    .health-score-btn.bad.selected {
      background: #e74c3c;
      border-color: #e74c3c;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“‹ ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«</h1>
      <p>ã‚ãªãŸã®ã‚¿ã‚¹ã‚¯ã¨åŠ´åƒæ™‚é–“ã‚’å¯è¦–åŒ–</p>
    </div>
    
    <div class="workload-card">
      <h2>ğŸ“Š ä»Šé€±ã®åŠ´åƒè² è·</h2>
      <div id="workload-stats" class="workload-stats">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div id="workload-progress" class="progress-bar" style="display: none;">
        <div class="progress-fill" style="width: 0%;">0%</div>
      </div>
    </div>
    
    <div class="main-content">
      <div class="card">
        <h2>â• ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h2>
        <form id="task-form" class="task-form">
          <div class="form-group">
            <label for="task-title">ã‚¿ã‚¤ãƒˆãƒ« *</label>
            <input type="text" id="task-title" name="title" required>
          </div>
          
          <div class="form-group">
            <label for="task-description">èª¬æ˜</label>
            <textarea id="task-description" name="description"></textarea>
          </div>
          
          <div class="form-group">
            <label for="task-hours">è¦‹ç©ã‚‚ã‚Šæ™‚é–“ï¼ˆæ™‚é–“ï¼‰ *</label>
            <input type="number" id="task-hours" name="estimatedHours" step="0.5" min="0" required>
          </div>
          
          <div class="form-group">
            <label for="task-priority">å„ªå…ˆåº¦</label>
            <select id="task-priority" name="priority">
              <option value="é«˜">é«˜</option>
              <option value="ä¸­" selected>ä¸­</option>
              <option value="ä½">ä½</option>
            </select>
          </div>
          
          <button type="submit" class="btn btn-primary">ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </button>
        </form>
      </div>
      
      <div class="card">
        <h2>ğŸ“ ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>
        <div id="task-list" class="task-list">
          <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div>
    
    <div class="card" style="margin-top: 20px;">
      <h2>ğŸ“… ä»Šé€±ã®ä¼šè­°äºˆå®š</h2>
      <div id="calendar-events" class="calendar-events">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
    
    <div class="card" style="margin-top: 20px;">
      <h2>ğŸ’š ä½“èª¿è¨˜éŒ²</h2>
      <form id="health-form" class="health-form">
        <div class="form-group">
          <label>ä»Šæ—¥ã®ä½“èª¿</label>
          <div class="health-score-buttons">
            <button type="button" class="health-score-btn good" data-score="è‰¯ã„" onclick="selectHealthScore('è‰¯ã„', this)">è‰¯ã„</button>
            <button type="button" class="health-score-btn" data-score="æ™®é€š" onclick="selectHealthScore('æ™®é€š', this)">æ™®é€š</button>
            <button type="button" class="health-score-btn bad" data-score="è‰¯ããªã„" onclick="selectHealthScore('è‰¯ããªã„', this)">è‰¯ããªã„</button>
          </div>
          <input type="hidden" id="health-score" name="score" required>
        </div>
        <div class="form-group">
          <label for="health-memo">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="health-memo" name="memo" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">ä½“èª¿ã‚’è¨˜éŒ²</button>
      </form>
    </div>
  </div>
  
  <!-- ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="edit-task-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†</h2>
        <span class="close" onclick="closeEditModal()">&times;</span>
      </div>
      <form id="edit-task-form" class="task-form">
        <input type="hidden" id="edit-task-id">
        <div class="form-group">
          <label for="edit-task-title">ã‚¿ã‚¤ãƒˆãƒ« *</label>
          <input type="text" id="edit-task-title" required>
        </div>
        <div class="form-group">
          <label for="edit-task-description">èª¬æ˜</label>
          <textarea id="edit-task-description"></textarea>
        </div>
        <div class="form-group">
          <label for="edit-task-hours">è¦‹ç©ã‚‚ã‚Šæ™‚é–“ï¼ˆæ™‚é–“ï¼‰ *</label>
          <input type="number" id="edit-task-hours" step="0.5" min="0" required>
        </div>
        <div class="form-group">
          <label for="edit-task-priority">å„ªå…ˆåº¦</label>
          <select id="edit-task-priority">
            <option value="é«˜">é«˜</option>
            <option value="ä¸­">ä¸­</option>
            <option value="ä½">ä½</option>
          </select>
        </div>
        <div style="display: flex; gap: 10px;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">æ›´æ–°</button>
          <button type="button" class="btn" onclick="closeEditModal()" style="flex: 1; background: #e0e0e0;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    window.onload = function() {
      loadData();
    };
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    function loadData() {
      loadTasks();
      loadWorkload();
      loadCalendarEvents();
    }
    
    // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    function loadTasks() {
      google.script.run
        .withSuccessHandler(displayTasks)
        .withFailureHandler(showError)
        .getTasks();
    }
    
    // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’è¡¨ç¤º
    function displayTasks(tasks) {
      const taskList = document.getElementById('task-list');
      
      if (tasks.error) {
        taskList.innerHTML = '<div class="error">ã‚¨ãƒ©ãƒ¼: ' + tasks.message + '</div>';
        return;
      }
      
      if (tasks.length === 0) {
        taskList.innerHTML = '<div class="loading">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      let html = '';
      tasks.forEach(task => {
        const priorityClass = `priority-${task.priority === 'é«˜' ? 'high' : task.priority === 'ä¸­' ? 'medium' : 'low'}`;
        const badgeClass = `badge-priority-${task.priority === 'é«˜' ? 'high' : task.priority === 'ä¸­' ? 'medium' : 'low'}`;
        const statusClass = `badge-status-${task.status === 'å®Œäº†' ? 'completed' : task.status === 'é€²è¡Œä¸­' ? 'in-progress' : task.status === 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' ? 'cancelled' : 'pending'}`;
        
        html += `
          <div class="task-item ${priorityClass}" data-task-id="${task.id}">
            <div class="task-header">
              <div class="task-title">${escapeHtml(task.title)}</div>
              <div class="task-meta">
                <select class="task-status-select" onchange="updateTaskStatus(${task.id}, this.value)">
                  <option value="æœªç€æ‰‹" ${task.status === 'æœªç€æ‰‹' ? 'selected' : ''}>æœªç€æ‰‹</option>
                  <option value="é€²è¡Œä¸­" ${task.status === 'é€²è¡Œä¸­' ? 'selected' : ''}>é€²è¡Œä¸­</option>
                  <option value="å®Œäº†" ${task.status === 'å®Œäº†' ? 'selected' : ''}>å®Œäº†</option>
                  <option value="ã‚­ãƒ£ãƒ³ã‚»ãƒ«" ${task.status === 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' ? 'selected' : ''}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                </select>
                <span class="badge ${badgeClass}">${escapeHtml(task.priority)}</span>
                <span class="badge badge-hours">${task.estimatedHours}æ™‚é–“</span>
              </div>
            </div>
            ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
            <div class="task-actions">
              <button class="btn-edit" onclick="editTask(${task.id})">ç·¨é›†</button>
              <button class="btn-delete" onclick="deleteTask(${task.id})">å‰Šé™¤</button>
            </div>
          </div>
        `;
      });
      
      taskList.innerHTML = html;
    }
    
    // åŠ´åƒè² è·ã‚’èª­ã¿è¾¼ã‚€
    function loadWorkload() {
      google.script.run
        .withSuccessHandler(displayWorkload)
        .withFailureHandler(showError)
        .getWeeklyWorkload();
    }
    
    // åŠ´åƒè² è·ã‚’è¡¨ç¤º
    function displayWorkload(data) {
      const statsContainer = document.getElementById('workload-stats');
      const progressBar = document.getElementById('workload-progress');
      
      if (data.error) {
        statsContainer.innerHTML = '<div class="error">ã‚¨ãƒ©ãƒ¼: ' + data.message + '</div>';
        return;
      }
      
      const utilizationRate = Math.round(data.utilizationRate);
      const progressClass = utilizationRate >= 100 ? 'high' : utilizationRate >= 80 ? 'medium' : 'low';
      
      statsContainer.innerHTML = `
        <div class="stat-item">
          <div class="stat-label">ã‚¿ã‚¹ã‚¯æ™‚é–“</div>
          <div class="stat-value">${data.totalTaskHours.toFixed(1)}æ™‚é–“</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ä¼šè­°æ™‚é–“</div>
          <div class="stat-value">${data.meetingHours.toFixed(1)}æ™‚é–“</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">åˆè¨ˆæ™‚é–“</div>
          <div class="stat-value ${progressClass}">${data.totalHours.toFixed(1)}æ™‚é–“</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ä½™åŠ›</div>
          <div class="stat-value ${data.availableHours < 0 ? 'high' : data.availableHours < 10 ? 'medium' : 'low'}">
            ${data.availableHours >= 0 ? data.availableHours.toFixed(1) : 'è¶…é'}æ™‚é–“
          </div>
        </div>
      `;
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
      const progressFill = progressBar.querySelector('.progress-fill');
      const progressWidth = Math.min(utilizationRate, 100);
      progressFill.style.width = progressWidth + '%';
      progressFill.textContent = utilizationRate + '%';
      progressBar.style.display = 'block';
    }
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚€
    function loadCalendarEvents() {
      google.script.run
        .withSuccessHandler(displayCalendarEvents)
        .withFailureHandler(showError)
        .getCalendarEvents();
    }
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤º
    function displayCalendarEvents(data) {
      const calendarContainer = document.getElementById('calendar-events');
      
      if (data.error) {
        calendarContainer.innerHTML = '<div class="error">ã‚¨ãƒ©ãƒ¼: ' + data.message + '</div>';
        return;
      }
      
      if (!data.events || data.events.length === 0) {
        calendarContainer.innerHTML = '<div class="loading">ä»Šé€±ã®ä¼šè­°äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      let html = '';
      data.events.forEach(event => {
        const startDate = new Date(event.startTime);
        const endDate = new Date(event.endTime);
        const dateStr = startDate.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
        const timeStr = startDate.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) + 
                       ' - ' + 
                       endDate.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        
        html += `
          <div class="calendar-event">
            <div class="calendar-event-title">${escapeHtml(event.title)}</div>
            <div class="calendar-event-time">${dateStr} ${timeStr} (${event.duration.toFixed(1)}æ™‚é–“)</div>
          </div>
        `;
      });
      
      calendarContainer.innerHTML = html;
    }
    
    // ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†
    document.getElementById('task-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = {
        title: document.getElementById('task-title').value,
        description: document.getElementById('task-description').value,
        estimatedHours: document.getElementById('task-hours').value,
        priority: document.getElementById('task-priority').value,
        status: 'æœªç€æ‰‹'
      };
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          } else {
            alert('ã‚¿ã‚¹ã‚¯ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼');
            document.getElementById('task-form').reset();
            loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
          }
        })
        .withFailureHandler(showError)
        .addTask(formData);
    });
    
    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(error) {
      console.error('Error:', error);
      alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
    
    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // ã‚¿ã‚¹ã‚¯ã®ç·¨é›†
    function editTask(taskId) {
      // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      google.script.run
        .withSuccessHandler(function(tasks) {
          if (tasks.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + tasks.message);
            return;
          }
          
          const task = tasks.find(t => t.id === taskId);
          if (!task) {
            alert('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
          }
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
          document.getElementById('edit-task-id').value = task.id;
          document.getElementById('edit-task-title').value = task.title;
          document.getElementById('edit-task-description').value = task.description || '';
          document.getElementById('edit-task-hours').value = task.estimatedHours;
          document.getElementById('edit-task-priority').value = task.priority;
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          document.getElementById('edit-task-modal').style.display = 'block';
        })
        .withFailureHandler(showError)
        .getTasks();
    }
    
    // ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡
    document.getElementById('edit-task-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const taskId = document.getElementById('edit-task-id').value;
      const taskData = {
        title: document.getElementById('edit-task-title').value,
        description: document.getElementById('edit-task-description').value,
        estimatedHours: document.getElementById('edit-task-hours').value,
        priority: document.getElementById('edit-task-priority').value
      };
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          } else {
            alert('ã‚¿ã‚¹ã‚¯ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼');
            closeEditModal();
            loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
          }
        })
        .withFailureHandler(showError)
        .updateTask(taskId, taskData);
    });
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeEditModal() {
      document.getElementById('edit-task-modal').style.display = 'none';
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.onclick = function(event) {
      const modal = document.getElementById('edit-task-modal');
      if (event.target === modal) {
        closeEditModal();
      }
    }
    
    // ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤
    function deleteTask(taskId) {
      if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          } else {
            alert('ã‚¿ã‚¹ã‚¯ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼');
            loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
          }
        })
        .withFailureHandler(showError)
        .deleteTask(taskId);
    }
    
    // ã‚¿ã‚¹ã‚¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    function updateTaskStatus(taskId, status) {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
            loadTasks(); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å†èª­ã¿è¾¼ã¿
          } else {
            loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
          }
        })
        .withFailureHandler(showError)
        .updateTaskStatus(taskId, status);
    }
    
    // ä½“èª¿ã‚¹ã‚³ã‚¢ã‚’é¸æŠ
    function selectHealthScore(score, button) {
      // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‹ã‚‰selectedã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      document.querySelectorAll('.health-score-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // é¸æŠã—ãŸãƒœã‚¿ãƒ³ã«selectedã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      button.classList.add('selected');
      
      // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
      document.getElementById('health-score').value = score;
    }
    
    // ä½“èª¿è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡
    document.getElementById('health-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const score = document.getElementById('health-score').value;
      if (!score) {
        alert('ä½“èª¿ã‚¹ã‚³ã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const healthData = {
        date: new Date().toISOString().split('T')[0],
        score: score,
        memo: document.getElementById('health-memo').value
      };
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
          } else {
            alert('ä½“èª¿ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸï¼');
            document.getElementById('health-form').reset();
            document.querySelectorAll('.health-score-btn').forEach(btn => {
              btn.classList.remove('selected');
            });
          }
        })
        .withFailureHandler(showError)
        .recordHealthScore(healthData);
    });
  </script>
</body>
</html>

