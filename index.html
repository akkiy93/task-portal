<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .header h1 {
      color: #667eea;
      margin: 0;
      font-size: 2rem;
    }
    
    .current-time {
      font-size: 1.2rem;
      font-weight: 600;
      color: #333;
      font-family: 'Courier New', monospace;
    }
    
    .header-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 20px;
    }
    
    @media (max-width: 768px) {
      .header-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .goal-input-wrapper {
        flex-direction: column;
      }
      
      .goal-input-wrapper .btn-small {
        align-self: flex-start;
      }
    }
    
    .header-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .header-item.full-width {
      width: 100%;
    }
    
    .health-status-wrapper {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .health-status-wrapper .health-status-buttons {
      flex: 1;
      display: flex;
      gap: 8px;
    }
    
    .health-status-wrapper .health-status-btn {
      flex: 0 0 30%;
    }
    
    .health-status-wrapper .btn-small {
      flex: 0 0 10%;
      margin-top: 0;
    }
    
    .header-item label {
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
    }
    
    .header-item input[type="text"],
    .header-item textarea {
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.95rem;
      font-family: inherit;
      resize: vertical;
      min-height: 60px;
    }
    
    .header-item input[type="text"]:focus,
    .header-item textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .header-item textarea {
      width: 100%;
    }
    
    .goal-input-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    
    .goal-input-wrapper textarea {
      width: 100%;
    }
    
    .goal-input-wrapper .btn-small {
      flex-shrink: 0;
    }
    
    .btn-small {
      padding: 6px 16px;
      font-size: 0.9rem;
      margin-top: 4px;
      align-self: flex-start;
    }
    
    .health-status-buttons {
      display: flex;
      gap: 8px;
    }
    
    .health-status-btn {
      flex: 1;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .health-status-btn:hover {
      border-color: #667eea;
    }
    
    .health-status-btn.selected {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .health-status-btn.good {
      border-color: #27ae60;
    }
    
    .health-status-btn.good.selected {
      background: #27ae60;
      border-color: #27ae60;
    }
    
    .health-status-btn.bad {
      border-color: #e74c3c;
    }
    
    .health-status-btn.bad.selected {
      background: #e74c3c;
      border-color: #e74c3c;
    }
    
    .workload-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .workload-card h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }
    
    .workload-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: #333;
    }
    
    .stat-value.high {
      color: #e74c3c;
    }
    
    .stat-value.medium {
      color: #f39c12;
    }
    
    .stat-value.low {
      color: #27ae60;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.9rem;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
      }
      
      /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’ä¸Šã€è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã‚’ä¸‹ã«é…ç½® */
      .main-content > .card:first-child {
        order: 2;
      }
      
      .main-content > .card:last-child {
        order: 1;
      }
      
      .task-controls-row {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
      }
      
      .sort-controls,
      .filter-controls {
        width: 100%;
        justify-content: space-between;
      }
      
      .task-header-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .task-info-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .task-title-main {
        font-size: 1.15rem;
      }
      
      .task-actions {
        flex-direction: column;
      }
      
      .btn-edit, .btn-delete {
        width: 100%;
      }
      
      .btn-submit-task {
        width: 100%;
        font-size: 1rem;
        padding: 14px 24px;
      }
      
      .form-group input[type="date"] {
        font-size: 16px; /* iOSã§ã‚ºãƒ¼ãƒ ã‚’é˜²ã */
      }
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .card h2 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }
    
    .task-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .form-group label {
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .form-group label .required-asterisk {
      color: #e74c3c;
      font-weight: bold;
      font-size: 1rem;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .btn-submit-task {
      background: linear-gradient(135deg, #5568d3 0%, #667eea 100%);
      font-size: 1.1rem;
      font-weight: 700;
      padding: 16px 32px;
      margin-top: 8px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .btn-submit-task:hover {
      background: linear-gradient(135deg, #4457c2 0%, #5568d3 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }
    
    .task-list-controls {
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
    }
    
    .task-controls-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 24px;
      flex-wrap: wrap;
    }
    
    .sort-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .sort-controls label {
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
    }
    
    .task-sort-select {
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.9rem;
      background: white;
      cursor: pointer;
      transition: border-color 0.3s;
    }
    
    .task-sort-select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn-sort-order {
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
      min-width: 40px;
    }
    
    .btn-sort-order:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }
    
    .filter-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    
    .toggle-switch input:checked + .toggle-slider {
      background-color: #667eea;
    }
    
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    .toggle-label {
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
      cursor: pointer;
    }
    
    .task-count-info {
      margin-top: 10px;
      font-size: 0.85rem;
      color: #666;
    }
    
    .task-list {
      max-height: 600px;
      overflow-y: auto;
    }
    
    .task-item {
      background: white;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      position: relative;
    }
    
    .task-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
      border-left-width: 5px;
    }
    
    .task-item.completed {
      opacity: 0.7;
      background: #f8f9fa;
    }
    
    .task-item.completed .task-title-main {
      text-decoration: line-through;
      color: #999;
    }
    
    .task-item.priority-high {
      border-left-color: #e74c3c;
      background: linear-gradient(to right, #fff5f5 0%, white 8%);
    }
    
    .task-item.priority-medium {
      border-left-color: #f39c12;
      background: linear-gradient(to right, #fffbf0 0%, white 8%);
    }
    
    .task-item.priority-low {
      border-left-color: #27ae60;
      background: linear-gradient(to right, #f0fff4 0%, white 8%);
    }
    
    .task-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .task-title-main {
      font-weight: 700;
      font-size: 1.1rem;
      color: #333;
      line-height: 1.4;
      margin: 0;
      flex: 1;
      min-width: 200px;
    }
    
    .task-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .task-info-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
    }
    
    .task-info-row-first,
    .task-info-row-second {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .task-description {
      color: #555;
      margin-top: 8px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      line-height: 1.5;
      padding-left: 4px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      line-height: 1.2;
    }
    
    .badge-priority-high {
      background: #fee;
      color: #e74c3c;
    }
    
    .badge-priority-medium {
      background: #fff4e6;
      color: #f39c12;
    }
    
    .badge-priority-low {
      background: #e8f5e9;
      color: #27ae60;
    }
    
    .badge-hours {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .badge-importance-high {
      background: #fce4ec;
      color: #c2185b;
    }
    
    .badge-importance-medium {
      background: #fff9c4;
      color: #f57f17;
    }
    
    .badge-importance-low {
      background: #e0f2f1;
      color: #00695c;
    }
    
    .badge-deliverable {
      background: #f3e5f5;
      color: #7b1fa2;
    }
    
    .badge-deadline {
      background: #fff3e0;
      color: #e65100;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    .error {
      background: #fee;
      color: #e74c3c;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .calendar-events {
      margin-top: 15px;
    }
    
    .calendar-event {
      background: #f0f4ff;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 0.9rem;
      border-left: 3px solid #667eea;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .calendar-event.today {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      font-size: 1.1rem;
      border-left: 5px solid white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      transform: scale(1.02);
    }
    
    .calendar-event.today .calendar-event-title {
      color: white;
      font-weight: 700;
    }
    
    .calendar-event.today .calendar-event-time {
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.95rem;
    }
    
    .calendar-event.this-week {
      background: #f0f4ff;
      padding: 12px;
      font-size: 0.95rem;
      border-left: 3px solid #667eea;
    }
    
    .calendar-event.future-week {
      background: #f8f9fa;
      padding: 10px;
      font-size: 0.85rem;
      border-left: 2px solid #999;
      opacity: 0.7;
    }
    
    .calendar-event-title {
      font-weight: 600;
      color: #667eea;
    }
    
    .calendar-event-time {
      color: #666;
      font-size: 0.85rem;
      margin-top: 4px;
    }
    
    .calendar-event-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      align-items: center;
    }
    
    .calendar-event-hide-btn {
      background: rgba(231, 76, 60, 0.1);
      color: #e74c3c;
      border: 1px solid #e74c3c;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .calendar-event-hide-btn:hover {
      background: #e74c3c;
      color: white;
    }
    
    .calendar-event.today .calendar-event-hide-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border-color: white;
    }
    
    .calendar-event.today .calendar-event-hide-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .calendar-view-toggle {
      display: flex;
      gap: 8px;
    }
    
    .view-toggle-btn {
      padding: 6px 12px;
      border: 1px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    
    .view-toggle-btn:hover {
      background: #f0f4ff;
    }
    
    .view-toggle-btn.active {
      background: #667eea;
      color: white;
    }
    
    .calendar-week-view {
      margin-top: 15px;
    }
    
    .calendar-week-navigation {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .calendar-week-nav-btn {
      padding: 8px 16px;
      border: 1px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      font-weight: 600;
    }
    
    .calendar-week-nav-btn:hover {
      background: #667eea;
      color: white;
    }
    
    .calendar-week-nav-btn:active {
      transform: scale(0.95);
    }
    
    .calendar-week-grid {
      display: grid;
      grid-template-columns: 80px repeat(7, 1fr);
      gap: 1px;
      background: #ddd;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .calendar-week-header {
      background: #667eea;
      color: white;
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .calendar-week-day-header {
      background: #764ba2;
      color: white;
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .calendar-week-day-header.today {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-size: 1.2rem;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }
    
    .calendar-week-day-header.today span {
      font-size: 1.5rem !important;
      font-weight: 800;
    }
    
    .calendar-week-time-slot {
      background: #f8f9fa;
      padding: 8px 4px;
      text-align: center;
      font-size: 0.75rem;
      color: #666;
      border-right: 1px solid #ddd;
    }
    
    .calendar-week-day-cell {
      background: white;
      min-height: 40px;
      padding: 2px;
      position: relative;
      border-right: 1px solid #ddd;
    }
    
    .calendar-week-event {
      position: absolute;
      left: 2px;
      right: 2px;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      z-index: 1;
      transition: all 0.2s;
    }
    
    .calendar-week-event:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      z-index: 2;
    }
    
    .calendar-week-event {
      background: #e3f2fd;
      color: #1976d2;
      border-left: 3px solid #1976d2;
    }
    
    .calendar-event-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow: auto;
    }
    
    .calendar-event-modal-content {
      background-color: white;
      margin: 3% auto;
      padding: 30px 35px;
      border-radius: 16px;
      width: 90%;
      max-width: 650px;
      max-height: 90vh;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .calendar-event-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .calendar-event-modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #667eea;
      margin: 0;
    }
    
    .calendar-event-modal-close {
      background: none;
      border: none;
      font-size: 2rem;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .calendar-event-modal-close:hover {
      background: #f0f0f0;
      color: #333;
    }
    
    .calendar-event-modal-body {
      margin-bottom: 20px;
      overflow-y: auto;
      flex: 1;
      padding-right: 5px;
    }
    
    .calendar-event-modal-body::-webkit-scrollbar {
      width: 6px;
    }
    
    .calendar-event-modal-body::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    .calendar-event-modal-body::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }
    
    .calendar-event-modal-body::-webkit-scrollbar-thumb:hover {
      background: #aaa;
    }
    
    .calendar-event-modal-info {
      margin-bottom: 18px;
    }
    
    .calendar-event-modal-info:last-child {
      margin-bottom: 0;
    }
    
    .calendar-event-modal-info-label {
      font-weight: 600;
      color: #555;
      font-size: 0.85rem;
      margin-bottom: 6px;
      letter-spacing: 0.5px;
    }
    
    .calendar-event-modal-info-value {
      color: #333;
      font-size: 1rem;
      line-height: 1.6;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: pre-wrap;
    }
    
    .calendar-event-modal-info-value.description {
      max-height: 300px;
      overflow-y: auto;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }
    
    .calendar-event-modal-info-value.description::-webkit-scrollbar {
      width: 6px;
    }
    
    .calendar-event-modal-info-value.description::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    .calendar-event-modal-info-value.description::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }
    
    .calendar-event-modal-info-value.description::-webkit-scrollbar-thumb:hover {
      background: #aaa;
    }
    
    .calendar-event-modal-info-value a {
      color: #667eea;
      text-decoration: none;
      word-break: break-all;
    }
    
    .calendar-event-modal-info-value a:hover {
      text-decoration: underline;
    }
    
    .calendar-event-modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding-top: 20px;
      border-top: 2px solid #f0f0f0;
      margin-top: auto;
      flex-shrink: 0;
    }
    
    .calendar-event-modal-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .calendar-event-modal-btn-exclude {
      background: #f39c12;
      color: white;
    }
    
    .calendar-event-modal-btn-exclude:hover {
      background: #e67e22;
    }
    
    .calendar-event-modal-btn-exclude.excluded {
      background: #27ae60;
    }
    
    .calendar-event-modal-btn-exclude.excluded:hover {
      background: #229954;
    }
    
    .calendar-event-modal-btn-close {
      background: #f0f0f0;
      color: #666;
    }
    
    .calendar-event-modal-btn-close:hover {
      background: #e0e0e0;
    }
    
    .calendar-week-event-exclude-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(243, 156, 18, 0.9);
      color: white;
      border: none;
      border-radius: 3px;
      padding: 2px 6px;
      font-size: 0.65rem;
      cursor: pointer;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .calendar-week-event:hover .calendar-week-event-exclude-btn {
      opacity: 1;
    }
    
    .calendar-week-event-exclude-btn.excluded {
      background: rgba(39, 174, 96, 0.9);
    }
    
    .task-actions {
      display: none; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã«ç§»å‹•ã—ãŸãŸã‚éè¡¨ç¤º */
    }
    
    /* ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ã®ç¸¦å¹…ç¸®å°ã®ãŸã‚ã®è¿½åŠ èª¿æ•´ */
    .task-header-actions {
      gap: 6px;
    }
    
    .btn-edit, .btn-delete {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-edit {
      background: #667eea;
      color: white;
    }
    
    .btn-edit:hover {
      background: #5568d3;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .btn-delete {
      background: #e74c3c;
      color: white;
    }
    
    .btn-delete:hover {
      background: #c0392b;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
    }
    
    .task-status-select {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      background: white;
      transition: all 0.2s;
    }
    
    .task-status-select:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    .task-status-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .badge-status-completed {
      background: #e8f5e9;
      color: #27ae60;
    }
    
    .badge-status-in-progress {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .badge-status-cancelled {
      background: #f5f5f5;
      color: #666;
    }
    
    .badge-status-pending {
      background: #fff4e6;
      color: #f39c12;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow-y: auto;
    }
    
    .modal-content {
      background-color: white;
      margin: 20px auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      position: relative;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      color: #667eea;
      margin: 0;
    }
    
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: #000;
    }
    
    .health-form,
    .daily-report-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .completed-tasks-info {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    
    .completed-tasks-summary {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .summary-item {
      font-size: 0.95rem;
      color: #555;
    }
    
    .summary-item strong {
      color: #667eea;
      font-size: 1.1rem;
    }
    
    .completed-tasks-list {
      margin: 10px 0 0 0;
      padding-left: 20px;
      list-style-type: disc;
    }
    
    .completed-tasks-list li {
      margin: 5px 0;
      color: #666;
    }
    
    .info {
      color: #666;
      font-style: italic;
    }
    
    .health-score-buttons {
      display: flex;
      gap: 10px;
    }
    
    .health-score-btn {
      flex: 1;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .health-score-btn:hover {
      border-color: #667eea;
    }
    
    .health-score-btn.selected {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .health-score-btn.good {
      border-color: #27ae60;
    }
    
    .health-score-btn.good.selected {
      background: #27ae60;
      border-color: #27ae60;
    }
    
    .health-score-btn.bad {
      border-color: #e74c3c;
    }
    
    .health-score-btn.bad.selected {
      background: #e74c3c;
      border-color: #e74c3c;
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .btn-loading {
      position: relative;
      color: transparent !important;
    }
    
    .btn-loading::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <h1>ğŸ“‹ ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«</h1>
        <div id="current-time" class="current-time"></div>
      </div>
      <div class="header-content">
        <div class="header-item full-width">
          <label for="daily-goal">ä»Šæ—¥ã®ç›®æ¨™</label>
          <textarea id="daily-goal" placeholder="ä»Šæ—¥ã®ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" rows="3"></textarea>
        </div>
        <div class="header-item">
          <label>ç¾åœ¨ã®ä½“èª¿</label>
          <div class="health-status-wrapper">
            <div class="health-status-buttons">
              <button type="button" class="health-status-btn good" data-score="è‰¯ã„" onclick="setHealthStatus('è‰¯ã„', this)">è‰¯ã„</button>
              <button type="button" class="health-status-btn" data-score="æ™®é€š" onclick="setHealthStatus('æ™®é€š', this)">æ™®é€š</button>
              <button type="button" class="health-status-btn bad" data-score="è‰¯ããªã„" onclick="setHealthStatus('è‰¯ããªã„', this)">è‰¯ããªã„</button>
            </div>
            <button type="button" id="save-goal-btn" class="btn btn-primary btn-small">ä¿å­˜</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="workload-card">
      <h2>ğŸ“Š ä»Šé€±ã®åŠ´åƒè² è·</h2>
      <div id="workload-stats" class="workload-stats">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div id="workload-progress" class="progress-bar" style="display: none;">
        <div class="progress-fill" style="width: 0%;">0%</div>
      </div>
    </div>
    
    <div class="main-content">
      <div class="card">
        <h2>â• ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h2>
        <form id="task-form" class="task-form">
          <div class="form-group">
            <label for="task-title">ã‚¿ã‚¤ãƒˆãƒ« <span class="required-asterisk">*</span></label>
            <input type="text" id="task-title" name="title" required>
          </div>
          
          <div class="form-group">
            <label for="task-description">èª¬æ˜</label>
            <textarea id="task-description" name="description"></textarea>
          </div>
          
          <div class="form-group">
            <label for="task-hours">è¦‹ç©ã‚‚ã‚Šæ™‚é–“ï¼ˆæ™‚é–“ï¼‰ <span class="required-asterisk">*</span></label>
            <input type="number" id="task-hours" name="estimatedHours" step="0.5" min="0" required>
          </div>
          
          <div class="form-group">
            <label for="task-matrix">ã‚¿ã‚¹ã‚¯ã®å„ªå…ˆåº¦ãƒ»é‡è¦åº¦</label>
            <select id="task-matrix" name="matrix">
              <option value="é«˜å„ªå…ˆ/é«˜é‡è¦">é«˜å„ªå…ˆ/é«˜é‡è¦ï¼ˆæœ€å„ªå…ˆï¼‰</option>
              <option value="é«˜å„ªå…ˆ/ä½é‡è¦">é«˜å„ªå…ˆ/ä½é‡è¦ï¼ˆæ€¥ã„ã§å¯¾å¿œï¼‰</option>
              <option value="ä½å„ªå…ˆ/é«˜é‡è¦" selected>ä½å„ªå…ˆ/é«˜é‡è¦ï¼ˆè¨ˆç”»çš„ã«å®Ÿè¡Œï¼‰</option>
              <option value="ä½å„ªå…ˆ/ä½é‡è¦">ä½å„ªå…ˆ/ä½é‡è¦ï¼ˆå¾Œå›ã—å¯ï¼‰</option>
            </select>
            <small style="color: #666; font-size: 0.8rem; margin-top: 4px; display: block;">
              å„ªå…ˆåº¦ï¼šã„ã¤ã¾ã§ã«ã‚„ã‚‹ã‹ / é‡è¦åº¦ï¼šæˆæœã®å¤§ãã•
            </small>
          </div>
          
          <div class="form-group">
            <label for="task-deliverable">æå‡ºå…ˆï¼ˆä»»æ„ï¼‰</label>
            <input type="text" id="task-deliverable" name="deliverable" placeholder="ä¾‹: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãªã©">
          </div>
          
          <div class="form-group">
            <label for="task-deadline">ç· åˆ‡æ—¥ï¼ˆä»»æ„ï¼‰</label>
            <input type="date" id="task-deadline" name="deadline">
          </div>
          
          <button type="submit" class="btn btn-primary btn-submit-task">â• ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </button>
        </form>
      </div>
      
      <div class="card">
        <h2>ğŸ“ ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>
        <div class="task-list-controls">
          <div class="task-controls-row">
            <div class="sort-controls">
              <label for="task-sort">ä¸¦ã³æ›¿ãˆ:</label>
              <select id="task-sort" class="task-sort-select">
                <option value="priority">å„ªå…ˆåº¦</option>
                <option value="deadline">ç· åˆ‡æ—¥</option>
                <option value="importance">é‡è¦åº¦</option>
                <option value="estimatedHours">è¦‹ç©ã‚‚ã‚Šæ™‚é–“</option>
                <option value="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                <option value="createdAt">ä½œæˆæ—¥æ™‚</option>
                <option value="updatedAt">æ›´æ–°æ—¥æ™‚</option>
                <option value="title">ã‚¿ã‚¤ãƒˆãƒ«</option>
              </select>
              <button id="sort-order-btn" class="btn-sort-order" onclick="toggleSortOrder()" title="æ˜‡é †/é™é †ã‚’åˆ‡ã‚Šæ›¿ãˆ">
                <span id="sort-order-icon">â†‘</span>
              </button>
            </div>
            <div class="filter-controls">
              <label class="toggle-switch">
                <input type="checkbox" id="show-completed-toggle" onchange="toggleCompletedTasks()">
                <span class="toggle-slider"></span>
              </label>
              <label for="show-completed-toggle" class="toggle-label">å®Œäº†ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º</label>
            </div>
          </div>
          <div id="task-count-info" class="task-count-info"></div>
        </div>
        <div id="task-list" class="task-list">
          <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div>
    
    <div class="card" style="margin-top: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 style="margin: 0;">ğŸ“… é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
        <div class="calendar-week-navigation">
          <button class="calendar-week-nav-btn" onclick="moveWeek(-1)" title="å‰ã®é€±">
            â—€ å‰ã®é€±
          </button>
          <button class="calendar-week-nav-btn" onclick="moveWeekToToday()" title="ä»Šé€±ã«æˆ»ã‚‹">
            ä»Šæ—¥
          </button>
          <button class="calendar-week-nav-btn" onclick="moveWeek(1)" title="æ¬¡ã®é€±">
            æ¬¡ã®é€± â–¶
          </button>
        </div>
      </div>
      <div id="calendar-week-info" style="margin-bottom: 10px; color: #666; font-size: 0.9rem;"></div>
      <div id="calendar-week-view" class="calendar-week-view">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
    
    <div class="card" style="margin-top: 20px;">
      <h2>ğŸ“ æ—¥å ±è¨˜å…¥æ¬„</h2>
      <form id="daily-report-form" class="daily-report-form">
        <div class="form-group">
          <label for="report-date">æ—¥ä»˜</label>
          <input type="date" id="report-date" name="date" required>
        </div>
        <div class="form-group">
          <label for="report-goal">ä»Šæ—¥ã®ç›®æ¨™</label>
          <input type="text" id="report-goal" name="goal" placeholder="ä»Šæ—¥ã®ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
        </div>
        <div class="form-group">
          <label>ä½“èª¿ã‚¹ã‚³ã‚¢</label>
          <div class="health-score-buttons">
            <button type="button" class="health-score-btn good" data-score="è‰¯ã„" onclick="selectReportHealthScore('è‰¯ã„', this)">è‰¯ã„</button>
            <button type="button" class="health-score-btn" data-score="æ™®é€š" onclick="selectReportHealthScore('æ™®é€š', this)">æ™®é€š</button>
            <button type="button" class="health-score-btn bad" data-score="è‰¯ããªã„" onclick="selectReportHealthScore('è‰¯ããªã„', this)">è‰¯ããªã„</button>
          </div>
          <input type="hidden" id="report-health-score" name="healthScore">
          <small style="color: #666; font-size: 0.85rem; display: block; margin-top: 5px;">â€» å‡ºç¤¾æ™‚ä½“èª¿ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œç¾åœ¨ã®ä½“èª¿ã€ãƒœã‚¿ãƒ³ã§è¨˜éŒ²ã—ã¦ãã ã•ã„</small>
        </div>
        <div class="form-group">
          <label>ä»Šæ—¥å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯</label>
          <div id="completed-tasks-info" class="completed-tasks-info">
            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>
        <div class="form-group">
          <label for="report-reflection">ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Š</label>
          <textarea id="report-reflection" name="reflection" rows="4" placeholder="ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
        </div>
        <div class="form-group">
          <label for="report-tomorrow-plan">æ˜æ—¥ã®äºˆå®šï¼ˆä»»æ„ï¼‰</label>
          <textarea id="report-tomorrow-plan" name="tomorrowPlan" rows="3" placeholder="æ˜æ—¥ã®äºˆå®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">æ—¥å ±ã‚’é€ä¿¡</button>
      </form>
    </div>
  </div>
  
  <!-- ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="edit-task-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†</h2>
        <span class="close" onclick="closeEditModal()">&times;</span>
      </div>
      <form id="edit-task-form" class="task-form">
        <input type="hidden" id="edit-task-id">
        <div class="form-group">
          <label for="edit-task-title">ã‚¿ã‚¤ãƒˆãƒ« <span class="required-asterisk">*</span></label>
          <input type="text" id="edit-task-title" required>
        </div>
        <div class="form-group">
          <label for="edit-task-description">èª¬æ˜</label>
          <textarea id="edit-task-description"></textarea>
        </div>
        <div class="form-group">
          <label for="edit-task-hours">è¦‹ç©ã‚‚ã‚Šæ™‚é–“ï¼ˆæ™‚é–“ï¼‰ <span class="required-asterisk">*</span></label>
          <input type="number" id="edit-task-hours" step="0.5" min="0" required>
        </div>
        <div class="form-group">
          <label for="edit-task-matrix">ã‚¿ã‚¹ã‚¯ã®å„ªå…ˆåº¦ãƒ»é‡è¦åº¦</label>
          <select id="edit-task-matrix">
            <option value="é«˜å„ªå…ˆ/é«˜é‡è¦">é«˜å„ªå…ˆ/é«˜é‡è¦ï¼ˆæœ€å„ªå…ˆï¼‰</option>
            <option value="é«˜å„ªå…ˆ/ä½é‡è¦">é«˜å„ªå…ˆ/ä½é‡è¦ï¼ˆæ€¥ã„ã§å¯¾å¿œï¼‰</option>
            <option value="ä½å„ªå…ˆ/é«˜é‡è¦">ä½å„ªå…ˆ/é«˜é‡è¦ï¼ˆè¨ˆç”»çš„ã«å®Ÿè¡Œï¼‰</option>
            <option value="ä½å„ªå…ˆ/ä½é‡è¦">ä½å„ªå…ˆ/ä½é‡è¦ï¼ˆå¾Œå›ã—å¯ï¼‰</option>
          </select>
          <small style="color: #666; font-size: 0.8rem; margin-top: 4px; display: block;">
            å„ªå…ˆåº¦ï¼šã„ã¤ã¾ã§ã«ã‚„ã‚‹ã‹ / é‡è¦åº¦ï¼šæˆæœã®å¤§ãã•
          </small>
        </div>
        <div class="form-group">
          <label for="edit-task-deliverable">æå‡ºå…ˆï¼ˆä»»æ„ï¼‰</label>
          <input type="text" id="edit-task-deliverable" placeholder="ä¾‹: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãªã©">
        </div>
        <div class="form-group">
          <label for="edit-task-deadline">ç· åˆ‡æ—¥ï¼ˆä»»æ„ï¼‰</label>
          <input type="date" id="edit-task-deadline">
        </div>
        <div style="display: flex; gap: 10px;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">æ›´æ–°</button>
          <button type="button" class="btn" onclick="closeEditModal()" style="flex: 1; background: #e0e0e0;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="calendar-event-modal" class="calendar-event-modal">
    <div class="calendar-event-modal-content">
      <div class="calendar-event-modal-header">
        <h3 class="calendar-event-modal-title" id="calendar-event-modal-title">äºˆå®šã®è©³ç´°</h3>
        <button class="calendar-event-modal-close" onclick="closeCalendarEventModal()">&times;</button>
      </div>
      <div class="calendar-event-modal-body">
        <div class="calendar-event-modal-info">
          <div class="calendar-event-modal-info-label">æ—¥æ™‚</div>
          <div class="calendar-event-modal-info-value" id="calendar-event-modal-datetime"></div>
        </div>
        <div class="calendar-event-modal-info">
          <div class="calendar-event-modal-info-label">å ´æ‰€</div>
          <div class="calendar-event-modal-info-value" id="calendar-event-modal-location"></div>
        </div>
        <div class="calendar-event-modal-info">
          <div class="calendar-event-modal-info-label">èª¬æ˜</div>
          <div class="calendar-event-modal-info-value description" id="calendar-event-modal-description"></div>
        </div>
        <div class="calendar-event-modal-info">
          <div class="calendar-event-modal-info-label">æ‰€è¦æ™‚é–“</div>
          <div class="calendar-event-modal-info-value" id="calendar-event-modal-duration"></div>
        </div>
      </div>
      <div class="calendar-event-modal-actions">
        <button class="calendar-event-modal-btn calendar-event-modal-btn-exclude" id="calendar-event-modal-exclude-btn">
          ğŸ“Š åŠ´åƒè² è·è¨ˆç®—ã‹ã‚‰é™¤å¤–
        </button>
        <button class="calendar-event-modal-btn calendar-event-modal-btn-close" onclick="closeCalendarEventModal()">
          é–‰ã˜ã‚‹
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // ============================================
    // å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    // ============================================
    
    /**
     * ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¨­å®š
     * @param {HTMLElement|string} button - ãƒœã‚¿ãƒ³è¦ç´ ã¾ãŸã¯ID
     * @param {boolean} isLoading - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã‹ã©ã†ã‹
     * @param {string} loadingText - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
     */
    function setButtonLoading(button, isLoading, loadingText) {
      const btn = typeof button === 'string' ? document.getElementById(button) : button;
      if (!btn) return;
      
      if (isLoading) {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
        btn.disabled = true;
        btn.dataset.originalText = btn.textContent || btn.value;
        if (loadingText) {
          if (btn.tagName === 'BUTTON') {
            btn.textContent = loadingText;
          } else if (btn.tagName === 'INPUT') {
            btn.value = loadingText;
          }
        }
        btn.classList.add('btn-loading');
      } else {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
        btn.disabled = false;
        if (btn.dataset.originalText) {
          if (btn.tagName === 'BUTTON') {
            btn.textContent = btn.dataset.originalText;
          } else if (btn.tagName === 'INPUT') {
            btn.value = btn.dataset.originalText;
          }
          delete btn.dataset.originalText;
        }
        btn.classList.remove('btn-loading');
      }
    }
    
    /**
     * GASé–¢æ•°å‘¼ã³å‡ºã—ã®ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆäºŒé‡é€ä¿¡é˜²æ­¢ï¼‰
     * ä½¿ç”¨ä¾‹:
     *   callGasWithLoading(button, function(enableButton) {
     *     return google.script.run
     *       .withSuccessHandler(function(result) {
     *         enableButton(); // å‡¦ç†å®Œäº†å¾Œã«å†æœ‰åŠ¹åŒ–
     *         // æˆåŠŸå‡¦ç†...
     *       })
     *       .withFailureHandler(function(error) {
     *         enableButton(); // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å†æœ‰åŠ¹åŒ–
     *         showError(error);
     *       })
     *       .someFunction();
     *   });
     * 
     * @param {HTMLElement|string|null} button - ãƒœã‚¿ãƒ³è¦ç´ ã€IDã€ã¾ãŸã¯null
     * @param {Function} gasCallFunction - GASé–¢æ•°å‘¼ã³å‡ºã—ã‚’è¿”ã™é–¢æ•°ï¼ˆenableButtoné–¢æ•°ã‚’å—ã‘å–ã‚‹ï¼‰
     * @param {Object} options - ã‚ªãƒ—ã‚·ãƒ§ãƒ³
     * @param {string} options.loadingText - ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆ
     */
    function callGasWithLoading(button, gasCallFunction, options) {
      options = options || {};
      const loadingText = options.loadingText || 'å‡¦ç†ä¸­...';
      
      // ãƒœã‚¿ãƒ³ã‚’å–å¾—
      let btn = null;
      if (button) {
        btn = typeof button === 'string' ? document.getElementById(button) : button;
      }
      
      // æ—¢ã«å‡¦ç†ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
      if (btn && btn.disabled) {
        return;
      }
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      if (btn) {
        setButtonLoading(btn, true, loadingText);
      }
      
      // å†æœ‰åŠ¹åŒ–é–¢æ•°ã‚’ä½œæˆ
      const enableButton = function() {
        if (btn) {
          setButtonLoading(btn, false);
        }
      };
      
      // GASé–¢æ•°ã‚’å‘¼ã³å‡ºã—ï¼ˆenableButtoné–¢æ•°ã‚’æ¸¡ã™ï¼‰
      return gasCallFunction(enableButton);
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    window.onload = function() {
      startClock();
      
      // ç›®æ¨™ã¨ä½“èª¿ã‚’å…ˆã«èª­ã¿è¾¼ã‚€
      loadTodayGoal();
      loadTodayHealth();
      
      // ãã®å¾Œã«ã‚¿ã‚¹ã‚¯é–¢é€£ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
      loadData();
      
      // æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ ã®æ—¥ä»˜ã‚’ä»Šæ—¥ã«è¨­å®š
      const today = new Date().toISOString().split('T')[0];
      const reportDateInput = document.getElementById('report-date');
      if (reportDateInput) {
        reportDateInput.value = today;
        
        // ä»Šæ—¥ã®æ—¥å ±ãƒ‡ãƒ¼ã‚¿ã¨å®Œäº†ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã‚€
        loadDailyReport(today);
        loadCompletedTasksToday(today);
      }
      
      // ã‚½ãƒ¼ãƒˆé¸æŠã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
      const sortSelect = document.getElementById('task-sort');
      if (sortSelect) {
        sortSelect.addEventListener('change', function() {
          currentSortBy = this.value;
          applyFiltersAndSort();
        });
      }
    };
    
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ™‚è¨ˆã®æ›´æ–°
    function startClock() {
      function updateClock() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('ja-JP', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          weekday: 'short'
        });
        const timeStr = now.toLocaleTimeString('ja-JP', {
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
        
        const timeElement = document.getElementById('current-time');
        if (timeElement) {
          timeElement.textContent = dateStr + ' ' + timeStr;
        }
      }
      
      // åˆå›è¡¨ç¤º
      updateClock();
      
      // 1ç§’ã”ã¨ã«æ›´æ–°
      setInterval(updateClock, 1000);
    }
    
    // ä»Šæ—¥ã®ç›®æ¨™ã‚’èª­ã¿è¾¼ã‚€
    function loadTodayGoal() {
      const today = new Date().toISOString().split('T')[0];
      const goalInput = document.getElementById('daily-goal');
      if (!goalInput) return;
      
      google.script.run
        .withSuccessHandler(function(goal) {
          console.log('loadTodayGoal: å–å¾—ã—ãŸç›®æ¨™:', goal);
          // getDailyGoal()ã¯æ–‡å­—åˆ—ã‚’è¿”ã™
          if (goal && typeof goal === 'string') {
            goalInput.value = goal;
          } else if (goal && typeof goal === 'object' && goal.error) {
            console.warn('loadTodayGoal: ã‚¨ãƒ©ãƒ¼:', goal.message);
            // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆç›®æ¨™ãŒæœªè¨­å®šã®å ´åˆã‚‚ã‚ã‚‹ï¼‰
          }
        })
        .withFailureHandler(function(error) {
          console.warn('loadTodayGoal: ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ï¼‰:', error);
          // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆç›®æ¨™ãŒæœªè¨­å®šã®å ´åˆã‚‚ã‚ã‚‹ï¼‰
        })
        .getDailyGoal(today);
    }
    
    // ä»Šæ—¥ã®ç›®æ¨™ã‚’ä¿å­˜
    document.getElementById('save-goal-btn').addEventListener('click', function() {
      const button = this;
      const goal = document.getElementById('daily-goal').value;
      const today = new Date().toISOString().split('T')[0];
      
      callGasWithLoading(button, function(enableButton) {
        return google.script.run
          .withSuccessHandler(function(result) {
            enableButton();
            if (result.error) {
              alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
            } else {
              alert('ç›®æ¨™ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
            }
          })
          .withFailureHandler(function(error) {
            enableButton();
            showError(error);
          })
          .saveDailyGoal(today, goal);
      }, { loadingText: 'ä¿å­˜ä¸­...' });
    });
    
    // ä½“èª¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨­å®š
    function setHealthStatus(score, buttonElement) {
      // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‹ã‚‰selectedã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      document.querySelectorAll('.health-status-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // é¸æŠã—ãŸãƒœã‚¿ãƒ³ã«selectedã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      buttonElement.classList.add('selected');
      
      // ä½“èª¿ã‚’è¨˜éŒ²ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãªã—ã§é™ã‹ã«è¨˜éŒ²ï¼‰
      const today = new Date().toISOString().split('T')[0];
      const healthData = {
        date: today,
        score: score,
        memo: ''
      };
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.error) {
            // ã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯é¸æŠã‚’å…ƒã«æˆ»ã™
            buttonElement.classList.remove('selected');
          }
          // æˆåŠŸæ™‚ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„ï¼ˆé™ã‹ã«è¨˜éŒ²ï¼‰
        })
        .withFailureHandler(function(error) {
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯é¸æŠã‚’å…ƒã«æˆ»ã™
          buttonElement.classList.remove('selected');
          showError(error);
        })
        .recordHealthScore(healthData);
    }
    
    // ä»Šæ—¥ã®ä½“èª¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆæ—¥å ±ã‚·ãƒ¼ãƒˆã‹ã‚‰ï¼‰
    function loadTodayHealth() {
      const today = new Date().toISOString().split('T')[0];
      google.script.run
        .withSuccessHandler(function(report) {
          console.log('loadTodayHealth: å–å¾—ã—ãŸæ—¥å ±:', report);
          if (report && !report.error && report.arrivalHealthScore) {
            // å‡ºç¤¾æ™‚ä½“èª¿ã‚’å–å¾—ã—ã¦ãƒœã‚¿ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
            const button = document.querySelector(`.health-status-btn[data-score="${report.arrivalHealthScore}"]`);
            if (button) {
              document.querySelectorAll('.health-status-btn').forEach(btn => {
                btn.classList.remove('selected');
              });
              button.classList.add('selected');
              console.log('loadTodayHealth: ä½“èª¿ãƒœã‚¿ãƒ³ã‚’é¸æŠ:', report.arrivalHealthScore);
            }
          } else {
            console.log('loadTodayHealth: ä½“èª¿ãƒ‡ãƒ¼ã‚¿ãªã—ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼');
          }
        })
        .withFailureHandler(function(error) {
          console.warn('loadTodayHealth: ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ï¼‰:', error);
          // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆä½“èª¿ãŒæœªè¨˜éŒ²ã®å ´åˆã‚‚ã‚ã‚‹ï¼‰
        })
        .getDailyReport(today);
    }
    // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    function loadData() {
      loadTasks();
      loadWorkload();
      loadCalendarEvents();
    }
    
    // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®çŠ¶æ…‹ç®¡ç†
    let allTasks = [];
    let currentSortBy = 'priority';
    let currentSortOrder = 'desc'; // 'asc' or 'desc'
    let showCompleted = false; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å®Œäº†ã‚¿ã‚¹ã‚¯ã‚’éè¡¨ç¤º
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®çŠ¶æ…‹ã‚’ç¢ºèª
    function debugSpreadsheetStatus() {
      console.log('=== DEBUG: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆçŠ¶æ…‹ç¢ºèªé–‹å§‹ ===');
      google.script.run
        .withSuccessHandler(function(status) {
          console.log('DEBUG: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆçŠ¶æ…‹:', status);
          if (status.error) {
            console.error('DEBUG: ã‚¨ãƒ©ãƒ¼:', status.message);
            if (status.stack) {
              console.error('DEBUG: ã‚¹ã‚¿ãƒƒã‚¯:', status.stack);
            }
          } else {
            console.log('DEBUG: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID:', status.spreadsheetId);
            console.log('DEBUG: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå:', status.spreadsheetName);
            console.log('DEBUG: ã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆ:', status.tasksSheet);
            console.log('DEBUG: æ—¥å ±ã‚·ãƒ¼ãƒˆ:', status.reportSheet);
          }
          console.log('=== DEBUG: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆçŠ¶æ…‹ç¢ºèªå®Œäº† ===');
        })
        .withFailureHandler(function(error) {
          console.error('DEBUG: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆçŠ¶æ…‹ç¢ºèªå¤±æ•—:', error);
        })
        .debugSpreadsheetStatus();
    }
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨: getTasks()ã®å‹•ä½œã‚’ç¢ºèª
    function debugGetTasks() {
      console.log('=== DEBUG: getTasks()å‹•ä½œç¢ºèªé–‹å§‹ ===');
      google.script.run
        .withSuccessHandler(function(tasks) {
          console.log('DEBUG: getTasks()æˆåŠŸ');
          console.log('DEBUG: å–å¾—ãƒ‡ãƒ¼ã‚¿:', tasks);
          console.log('DEBUG: ãƒ‡ãƒ¼ã‚¿å‹:', typeof tasks);
          console.log('DEBUG: é…åˆ—ã‹:', Array.isArray(tasks));
          console.log('DEBUG: ãƒ‡ãƒ¼ã‚¿æ•°:', tasks ? tasks.length : 0);
          
          if (tasks && Array.isArray(tasks) && tasks.length > 0) {
            console.log('DEBUG: æœ€åˆã®ã‚¿ã‚¹ã‚¯:', tasks[0]);
            console.log('DEBUG: å…¨ã‚¿ã‚¹ã‚¯:', JSON.stringify(tasks, null, 2));
          }
          
          // è¡¨ç¤ºé–¢æ•°ã«æ¸¡ã™ãƒ†ã‚¹ãƒˆ
          console.log('=== DEBUG: displayTasks()ã«æ¸¡ã™ãƒ†ã‚¹ãƒˆ ===');
          displayTasks(tasks);
          console.log('=== DEBUG: getTasks()å‹•ä½œç¢ºèªå®Œäº† ===');
        })
        .withFailureHandler(function(error) {
          console.error('DEBUG: getTasks()å¤±æ•—:', error);
        })
        .debugGetTasks();
    }
    
    // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    function loadTasks() {
      google.script.run
        .withSuccessHandler(function(result) {
          let tasks = [];
          let parsedResult = null;
          
          // JSONæ–‡å­—åˆ—ã®å ´åˆ
          if (typeof result === 'string') {
            try {
              parsedResult = JSON.parse(result);
            } catch (parseError) {
              console.error('loadTasks: JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', parseError);
              allTasks = [];
              applyFiltersAndSort();
              showError('ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
              return;
            }
          } 
          // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
          else if (result && typeof result === 'object' && !Array.isArray(result)) {
            parsedResult = result;
          }
          // nullã‚„undefinedã®å ´åˆ
          else if (!result) {
            allTasks = [];
            applyFiltersAndSort();
            return;
          }
          // é…åˆ—ã§ç›´æ¥è¿”ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
          else if (Array.isArray(result)) {
            tasks = result;
            allTasks = tasks;
            applyFiltersAndSort();
            return;
          }
          // ãã®ä»–ã®å ´åˆ
          else {
            console.warn('loadTasks: äºˆæœŸã—ãªã„å½¢å¼:', result);
            allTasks = [];
            applyFiltersAndSort();
            return;
          }
          
          // parsedResultã‹ã‚‰tasksã‚’æŠ½å‡º
          if (parsedResult) {
            if (parsedResult.success && Array.isArray(parsedResult.tasks)) {
              tasks = parsedResult.tasks;
            } else if (parsedResult.error) {
              console.error('loadTasks: ã‚¨ãƒ©ãƒ¼:', parsedResult.message);
              allTasks = [];
              applyFiltersAndSort();
              showError(parsedResult.message || 'ã‚¿ã‚¹ã‚¯ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
              return;
            } else {
              console.warn('loadTasks: äºˆæœŸã—ãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå½¢å¼:', parsedResult);
              tasks = [];
            }
          }
          
          allTasks = tasks;
          applyFiltersAndSort();
        })
        .withFailureHandler(function(error) {
          console.error('getTasks failed:', error);
          allTasks = [];
          applyFiltersAndSort();
          showError(error);
        })
        .getTasks();
    }
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨ã‚½ãƒ¼ãƒˆã‚’é©ç”¨
    function applyFiltersAndSort() {
      let filteredTasks = filterCompletedTasks(allTasks, showCompleted);
      let sortedTasks = sortTasks(filteredTasks, currentSortBy, currentSortOrder);
      displayTasks(sortedTasks);
      updateTaskCountInfo(allTasks, filteredTasks);
    }
    
    // å®Œäº†ã‚¿ã‚¹ã‚¯ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterCompletedTasks(tasks, showCompleted) {
      if (!tasks || !Array.isArray(tasks)) {
        return [];
      }
      if (showCompleted) {
        return tasks;
      }
      return tasks.filter(task => task && task.status !== 'å®Œäº†');
    }
    
    // ã‚¿ã‚¹ã‚¯ã®ã‚½ãƒ¼ãƒˆï¼ˆæœ€é©åŒ–ç‰ˆï¼šè¤‡æ•°æ¡ä»¶ã‚½ãƒ¼ãƒˆå¯¾å¿œï¼‰
    function sortTasks(tasks, sortBy, sortOrder) {
      if (!tasks || !Array.isArray(tasks)) {
        return [];
      }
      const sorted = [...tasks].sort((a, b) => {
        if (!a || !b) return 0; // nullãƒã‚§ãƒƒã‚¯
        let aVal, bVal;
        let aVal2, bVal2; // 2æ¬¡ã‚½ãƒ¼ãƒˆç”¨
        
        switch(sortBy) {
          case 'priority':
            // å„ªå…ˆåº¦ â†’ é‡è¦åº¦ â†’ ç· åˆ‡æ—¥ ã®é †ã§ã‚½ãƒ¼ãƒˆ
            const priorityOrder = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
            aVal = priorityOrder[a.priority] || 0;
            bVal = priorityOrder[b.priority] || 0;
            // åŒã˜å„ªå…ˆåº¦ã®å ´åˆã€é‡è¦åº¦ã§æ¯”è¼ƒ
            if (aVal === bVal) {
              const importanceOrder = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
              aVal2 = importanceOrder[a.importance] || 0;
              bVal2 = importanceOrder[b.importance] || 0;
              if (aVal2 !== bVal2) {
                return sortOrder === 'asc' ? aVal2 - bVal2 : bVal2 - aVal2;
              }
              // åŒã˜é‡è¦åº¦ã®å ´åˆã€ç· åˆ‡æ—¥ã§æ¯”è¼ƒ
              if (a.deadline && b.deadline) {
                aVal2 = new Date(a.deadline).getTime();
                bVal2 = new Date(b.deadline).getTime();
                return sortOrder === 'asc' ? aVal2 - bVal2 : bVal2 - aVal2;
              }
              if (!a.deadline && b.deadline) return 1;
              if (a.deadline && !b.deadline) return -1;
            }
            break;
          case 'deadline':
            // ç· åˆ‡æ—¥ â†’ å„ªå…ˆåº¦ â†’ é‡è¦åº¦ ã®é †ã§ã‚½ãƒ¼ãƒˆ
            if (!a.deadline && !b.deadline) {
              // ä¸¡æ–¹ç· åˆ‡æ—¥ãŒãªã„å ´åˆã€å„ªå…ˆåº¦ã§æ¯”è¼ƒ
              const priorityOrder = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
              aVal = priorityOrder[a.priority] || 0;
              bVal = priorityOrder[b.priority] || 0;
              if (aVal !== bVal) {
                return sortOrder === 'asc' ? bVal - aVal : aVal - bVal;
              }
              // åŒã˜å„ªå…ˆåº¦ã®å ´åˆã€é‡è¦åº¦ã§æ¯”è¼ƒ
              const importanceOrder = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
              aVal2 = importanceOrder[a.importance] || 0;
              bVal2 = importanceOrder[b.importance] || 0;
              return sortOrder === 'asc' ? bVal2 - aVal2 : aVal2 - bVal2;
            }
            if (!a.deadline) return 1; // ç· åˆ‡æ—¥ãŒãªã„ã‚‚ã®ã¯å¾Œã‚ã«
            if (!b.deadline) return -1;
            aVal = new Date(a.deadline).getTime();
            bVal = new Date(b.deadline).getTime();
            // åŒã˜ç· åˆ‡æ—¥ã®å ´åˆã€å„ªå…ˆåº¦ã§æ¯”è¼ƒ
            if (aVal === bVal) {
              const priorityOrder = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
              aVal2 = priorityOrder[a.priority] || 0;
              bVal2 = priorityOrder[b.priority] || 0;
              return sortOrder === 'asc' ? bVal2 - aVal2 : aVal2 - bVal2;
            }
            break;
          case 'importance':
            // é‡è¦åº¦ â†’ å„ªå…ˆåº¦ â†’ ç· åˆ‡æ—¥ ã®é †ã§ã‚½ãƒ¼ãƒˆ
            const importanceOrder = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
            aVal = importanceOrder[a.importance] || 0;
            bVal = importanceOrder[b.importance] || 0;
            // åŒã˜é‡è¦åº¦ã®å ´åˆã€å„ªå…ˆåº¦ã§æ¯”è¼ƒ
            if (aVal === bVal) {
              const priorityOrder = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
              aVal2 = priorityOrder[a.priority] || 0;
              bVal2 = priorityOrder[b.priority] || 0;
              if (aVal2 !== bVal2) {
                return sortOrder === 'asc' ? aVal2 - bVal2 : bVal2 - aVal2;
              }
              // åŒã˜å„ªå…ˆåº¦ã®å ´åˆã€ç· åˆ‡æ—¥ã§æ¯”è¼ƒ
              if (a.deadline && b.deadline) {
                aVal2 = new Date(a.deadline).getTime();
                bVal2 = new Date(b.deadline).getTime();
                return sortOrder === 'asc' ? aVal2 - bVal2 : bVal2 - aVal2;
              }
              if (!a.deadline && b.deadline) return 1;
              if (a.deadline && !b.deadline) return -1;
            }
            break;
          case 'estimatedHours':
            aVal = parseFloat(a.estimatedHours) || 0;
            bVal = parseFloat(b.estimatedHours) || 0;
            // åŒã˜æ™‚é–“ã®å ´åˆã€å„ªå…ˆåº¦ã§æ¯”è¼ƒ
            if (aVal === bVal) {
              const priorityOrder = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
              aVal2 = priorityOrder[a.priority] || 0;
              bVal2 = priorityOrder[b.priority] || 0;
              return sortOrder === 'asc' ? bVal2 - aVal2 : aVal2 - bVal2;
            }
            break;
          case 'status':
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é †ï¼šæœªç€æ‰‹ â†’ é€²è¡Œä¸­ â†’ å®Œäº† â†’ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            const statusOrder = { 'æœªç€æ‰‹': 4, 'é€²è¡Œä¸­': 3, 'å®Œäº†': 2, 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«': 1 };
            aVal = statusOrder[a.status] || 0;
            bVal = statusOrder[b.status] || 0;
            // åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å ´åˆã€å„ªå…ˆåº¦ã§æ¯”è¼ƒ
            if (aVal === bVal) {
              const priorityOrder = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
              aVal2 = priorityOrder[a.priority] || 0;
              bVal2 = priorityOrder[b.priority] || 0;
              return sortOrder === 'asc' ? bVal2 - aVal2 : aVal2 - bVal2;
            }
            break;
          case 'createdAt':
            aVal = a.createdAt ? new Date(a.createdAt).getTime() : 0;
            bVal = b.createdAt ? new Date(b.createdAt).getTime() : 0;
            // åŒã˜ä½œæˆæ—¥æ™‚ã®å ´åˆã€å„ªå…ˆåº¦ã§æ¯”è¼ƒ
            if (aVal === bVal) {
              const priorityOrder = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
              aVal2 = priorityOrder[a.priority] || 0;
              bVal2 = priorityOrder[b.priority] || 0;
              return sortOrder === 'asc' ? bVal2 - aVal2 : aVal2 - bVal2;
            }
            break;
          case 'updatedAt':
            aVal = a.updatedAt ? new Date(a.updatedAt).getTime() : 0;
            bVal = b.updatedAt ? new Date(b.updatedAt).getTime() : 0;
            // åŒã˜æ›´æ–°æ—¥æ™‚ã®å ´åˆã€å„ªå…ˆåº¦ã§æ¯”è¼ƒ
            if (aVal === bVal) {
              const priorityOrder = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
              aVal2 = priorityOrder[a.priority] || 0;
              bVal2 = priorityOrder[b.priority] || 0;
              return sortOrder === 'asc' ? bVal2 - aVal2 : aVal2 - bVal2;
            }
            break;
          case 'title':
            aVal = (a.title || '').toLowerCase();
            bVal = (b.title || '').toLowerCase();
            // åŒã˜ã‚¿ã‚¤ãƒˆãƒ«ã®å ´åˆã€å„ªå…ˆåº¦ã§æ¯”è¼ƒ
            if (aVal === bVal) {
              const priorityOrder = { 'é«˜': 3, 'ä¸­': 2, 'ä½': 1 };
              aVal2 = priorityOrder[a.priority] || 0;
              bVal2 = priorityOrder[b.priority] || 0;
              return sortOrder === 'asc' ? bVal2 - aVal2 : aVal2 - bVal2;
            }
            break;
          default:
            return 0;
        }
        
        // ãƒ¡ã‚¤ãƒ³ã®æ¯”è¼ƒ
        if (sortBy === 'title') {
          return sortOrder === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        } else {
          return sortOrder === 'asc' ? aVal - bVal : bVal - aVal;
        }
      });
      
      return sorted;
    }
    
    // ã‚½ãƒ¼ãƒˆé †ã‚’åˆ‡ã‚Šæ›¿ãˆ
    function toggleSortOrder() {
      currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
      const icon = document.getElementById('sort-order-icon');
      icon.textContent = currentSortOrder === 'asc' ? 'â†‘' : 'â†“';
      applyFiltersAndSort();
    }
    
    // å®Œäº†ã‚¿ã‚¹ã‚¯ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    function toggleCompletedTasks() {
      const toggle = document.getElementById('show-completed-toggle');
      showCompleted = toggle.checked;
      applyFiltersAndSort();
    }
    
    // ã‚¿ã‚¹ã‚¯ä»¶æ•°æƒ…å ±ã‚’æ›´æ–°
    function updateTaskCountInfo(allTasks, filteredTasks) {
      const countInfo = document.getElementById('task-count-info');
      if (!countInfo) return;
      
      if (!allTasks || !Array.isArray(allTasks)) {
        allTasks = [];
      }
      if (!filteredTasks || !Array.isArray(filteredTasks)) {
        filteredTasks = [];
      }
      
      const totalCount = allTasks.length;
      const completedCount = allTasks.filter(t => t && t.status === 'å®Œäº†').length;
      const activeCount = totalCount - completedCount;
      const displayedCount = filteredTasks.length;
      
      if (showCompleted) {
        countInfo.textContent = `å…¨${totalCount}ä»¶ä¸­${displayedCount}ä»¶ã‚’è¡¨ç¤ºï¼ˆå®Œäº†: ${completedCount}ä»¶ã€æœªå®Œäº†: ${activeCount}ä»¶ï¼‰`;
      } else {
        countInfo.textContent = `å…¨${totalCount}ä»¶ä¸­${displayedCount}ä»¶ã‚’è¡¨ç¤ºï¼ˆå®Œäº†${completedCount}ä»¶ã¯éè¡¨ç¤ºï¼‰`;
      }
    }
    
    // ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’è¡¨ç¤º
    function displayTasks(tasks) {
      console.log('=== displayTasks() é–‹å§‹ ===');
      console.log('displayTasks: å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿:', tasks);
      console.log('displayTasks: ãƒ‡ãƒ¼ã‚¿å‹:', typeof tasks);
      console.log('displayTasks: é…åˆ—ã‹:', Array.isArray(tasks));
      
      const taskList = document.getElementById('task-list');
      if (!taskList) {
        console.error('displayTasks: task-listè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      if (tasks && tasks.error) {
        console.error('displayTasks: ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘å–ã‚Šã¾ã—ãŸ:', tasks);
        taskList.innerHTML = '<div class="error">ã‚¨ãƒ©ãƒ¼: ' + tasks.message + '</div>';
        return;
      }
      
      if (!tasks || !Array.isArray(tasks)) {
        console.warn('displayTasks: ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚Šã¾ã—ãŸ:', tasks);
        taskList.innerHTML = '<div class="error">ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      if (tasks.length === 0) {
        console.log('displayTasks: ã‚¿ã‚¹ã‚¯ãŒ0ä»¶');
        taskList.innerHTML = '<div class="loading">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      console.log('displayTasks: è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¹ã‚¯æ•°:', tasks.length);
      
      let html = '';
      tasks.forEach(task => {
        const priorityClass = `priority-${task.priority === 'é«˜' ? 'high' : task.priority === 'ä¸­' ? 'medium' : 'low'}`;
        const badgeClass = `badge-priority-${task.priority === 'é«˜' ? 'high' : task.priority === 'ä¸­' ? 'medium' : 'low'}`;
        const importanceBadgeClass = `badge-importance-${task.importance === 'é«˜' ? 'high' : task.importance === 'ä¸­' ? 'medium' : 'low'}`;
        const statusClass = `badge-status-${task.status === 'å®Œäº†' ? 'completed' : task.status === 'é€²è¡Œä¸­' ? 'in-progress' : task.status === 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' ? 'cancelled' : 'pending'}`;
        const isCompleted = task.status === 'å®Œäº†';
        
        // ç· åˆ‡æ—¥ã®è­¦å‘Šåˆ¤å®šï¼ˆ3æ—¥ä»¥å†…ï¼‰
        let deadlineClass = '';
        let deadlineWarning = false;
        if (task.deadline) {
          const deadline = new Date(task.deadline);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const diffTime = deadline - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          if (diffDays >= 0 && diffDays <= 3) {
            deadlineWarning = true;
            deadlineClass = 'deadline-warning';
          }
        }
        
        html += `
          <div class="task-item ${priorityClass} ${isCompleted ? 'completed' : ''}" data-task-id="${task.id}">
            <div class="task-header-row">
              <div class="task-title-main">${escapeHtml(task.title)}</div>
              <div class="task-header-actions">
                <select class="task-status-select" onchange="updateTaskStatus(${task.id}, this.value, this)">
                  <option value="æœªç€æ‰‹" ${task.status === 'æœªç€æ‰‹' ? 'selected' : ''}>æœªç€æ‰‹</option>
                  <option value="é€²è¡Œä¸­" ${task.status === 'é€²è¡Œä¸­' ? 'selected' : ''}>é€²è¡Œä¸­</option>
                  <option value="å®Œäº†" ${task.status === 'å®Œäº†' ? 'selected' : ''}>å®Œäº†</option>
                  <option value="ã‚­ãƒ£ãƒ³ã‚»ãƒ«" ${task.status === 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' ? 'selected' : ''}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                </select>
                <button class="btn-edit" onclick="editTask(${task.id}, this)">âœï¸ ç·¨é›†</button>
                <button class="btn-delete" onclick="deleteTask(${task.id}, this)">ğŸ—‘ï¸ å‰Šé™¤</button>
              </div>
            </div>
            <div class="task-info-row">
              <div class="task-info-row-first">
                ${task.deliverable ? `<span class="badge badge-deliverable">ğŸ“ æå‡ºå…ˆ: ${escapeHtml(task.deliverable)}</span>` : ''}
                ${task.deadline ? `<span class="badge badge-deadline ${deadlineClass}">ğŸ“… ç· åˆ‡: ${formatDate(task.deadline)}</span>` : ''}
              </div>
              <div class="task-info-row-second">
                <span class="badge ${badgeClass}">å„ªå…ˆåº¦ï¼š${escapeHtml(task.priority)}</span>
                <span class="badge ${importanceBadgeClass}">é‡è¦åº¦ï¼š${escapeHtml(task.importance || 'ä¸­')}</span>
                <span class="badge badge-hours">æƒ³å®šæ™‚é–“ï¼š${task.estimatedHours}æ™‚é–“</span>
              </div>
            </div>
            ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
          </div>
        `;
      });
      
      taskList.innerHTML = html;
    }
    
    // åŠ´åƒè² è·ã‚’èª­ã¿è¾¼ã‚€
    function loadWorkload() {
      google.script.run
        .withSuccessHandler(displayWorkload)
        .withFailureHandler(showError)
        .getWeeklyWorkload();
    }
    
    // åŠ´åƒè² è·ã‚’è¡¨ç¤º
    function displayWorkload(data) {
      const statsContainer = document.getElementById('workload-stats');
      const progressBar = document.getElementById('workload-progress');
      
      if (data.error) {
        statsContainer.innerHTML = '<div class="error">ã‚¨ãƒ©ãƒ¼: ' + data.message + '</div>';
        return;
      }
      
      const utilizationRate = Math.round(data.utilizationRate);
      const progressClass = utilizationRate >= 100 ? 'high' : utilizationRate >= 80 ? 'medium' : 'low';
      
      statsContainer.innerHTML = `
        <div class="stat-item">
          <div class="stat-label">ã‚¿ã‚¹ã‚¯æ™‚é–“</div>
          <div class="stat-value">${data.totalTaskHours.toFixed(1)}æ™‚é–“</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ä¼šè­°æ™‚é–“</div>
          <div class="stat-value">${data.meetingHours.toFixed(1)}æ™‚é–“</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">åˆè¨ˆæ™‚é–“</div>
          <div class="stat-value ${progressClass}">${data.totalHours.toFixed(1)}æ™‚é–“</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ä½™åŠ›</div>
          <div class="stat-value ${data.availableHours < 0 ? 'high' : data.availableHours < 10 ? 'medium' : 'low'}">
            ${data.availableHours >= 0 ? data.availableHours.toFixed(1) : 'è¶…é'}æ™‚é–“
          </div>
        </div>
      `;
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
      const progressFill = progressBar.querySelector('.progress-fill');
      const progressWidth = Math.min(utilizationRate, 100);
      progressFill.style.width = progressWidth + '%';
      progressFill.textContent = utilizationRate + '%';
      progressBar.style.display = 'block';
    }
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚€
    function loadCalendarEvents() {
      const startOfWeek = getCurrentWeekStart();
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 7);
      
      google.script.run
        .withSuccessHandler(displayCalendarEvents)
        .withFailureHandler(showError)
        .getCalendarEvents(startOfWeek.toISOString(), endOfWeek.toISOString());
    }
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤ºï¼ˆé€±è¡¨ç¤ºã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ï¼‰
    function displayCalendarEvents(data) {
      // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      window.calendarEventsData = data;
      // é€±è¡¨ç¤ºã‚’æ›´æ–°
      displayWeekCalendar(data);
    }
    
    // åŠ´åƒè² è·è¨ˆç®—ã®é™¤å¤–/å«ã‚ã‚‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
    function toggleWorkloadExclusion(eventId, buttonElement) {
      if (!eventId) {
        alert('ã‚¤ãƒ™ãƒ³ãƒˆIDãŒç„¡åŠ¹ã§ã™');
        return;
      }
      
      if (!window.calendarEventsData || !window.calendarEventsData.excludedEventIds) {
        alert('ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      const isExcluded = window.calendarEventsData.excludedEventIds.includes(eventId);
      const action = isExcluded ? 'includeEventInWorkload' : 'excludeEventFromWorkload';
      const actionText = isExcluded ? 'è¨ˆç®—ã«å«ã‚ã‚‹' : 'è¨ˆç®—ã‹ã‚‰é™¤å¤–';
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      if (buttonElement) {
        buttonElement.disabled = true;
        buttonElement.textContent = 'å‡¦ç†ä¸­...';
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
            if (buttonElement) {
              buttonElement.disabled = false;
              updateExcludeButtonState(buttonElement, isExcluded);
            }
          } else {
            // æˆåŠŸã—ãŸã‚‰é™¤å¤–ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            if (isExcluded) {
              // é™¤å¤–ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
              window.calendarEventsData.excludedEventIds = 
                window.calendarEventsData.excludedEventIds.filter(id => id !== eventId);
            } else {
              // é™¤å¤–ãƒªã‚¹ãƒˆã«è¿½åŠ 
              if (!window.calendarEventsData.excludedEventIds) {
                window.calendarEventsData.excludedEventIds = [];
              }
              window.calendarEventsData.excludedEventIds.push(eventId);
            }
            
            // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
            if (buttonElement) {
              buttonElement.disabled = false;
              updateExcludeButtonState(buttonElement, !isExcluded);
            }
            
            // åŠ´åƒè² è·ã‚’å†èª­ã¿è¾¼ã¿
            loadWorkload();
            
            // é€±è¡¨ç¤ºã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°ï¼ˆãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’åæ˜ ï¼‰
            displayWeekCalendar(window.calendarEventsData);
          }
        })
        .withFailureHandler(function(error) {
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
          if (buttonElement) {
            buttonElement.disabled = false;
            updateExcludeButtonState(buttonElement, isExcluded);
          }
        })[action](eventId);
    }
    
    // é™¤å¤–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    function updateExcludeButtonState(buttonElement, isExcluded) {
      if (buttonElement.classList.contains('calendar-week-event-exclude-btn')) {
        // é€±è¡¨ç¤ºã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒœã‚¿ãƒ³
        if (isExcluded) {
          buttonElement.textContent = 'âœ“ è¨ˆç®—ã«å«ã‚ã‚‹';
          buttonElement.classList.add('excluded');
        } else {
          buttonElement.textContent = 'ğŸ“Š é™¤å¤–';
          buttonElement.classList.remove('excluded');
        }
      } else if (buttonElement.id === 'calendar-event-modal-exclude-btn') {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒœã‚¿ãƒ³
        if (isExcluded) {
          buttonElement.textContent = 'âœ“ åŠ´åƒè² è·è¨ˆç®—ã«å«ã‚ã‚‹';
          buttonElement.classList.add('excluded');
        } else {
          buttonElement.textContent = 'ğŸ“Š åŠ´åƒè² è·è¨ˆç®—ã‹ã‚‰é™¤å¤–';
          buttonElement.classList.remove('excluded');
        }
      }
    }
    
    // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹é€±ã®é–‹å§‹æ—¥ã‚’ä¿æŒ
    window.currentWeekStart = null;
    
    // æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ã®é€±ã®é–‹å§‹æ—¥ï¼ˆæ—¥æ›œæ—¥ï¼‰ã‚’å–å¾—
    function getStartOfWeek(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() - d.getDay());
      return d;
    }
    
    // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹é€±ã®é–‹å§‹æ—¥ã‚’å–å¾—ï¼ˆæœªè¨­å®šã®å ´åˆã¯ä»Šé€±ï¼‰
    function getCurrentWeekStart() {
      if (window.currentWeekStart) {
        return new Date(window.currentWeekStart);
      }
      const today = new Date();
      window.currentWeekStart = getStartOfWeek(today);
      return new Date(window.currentWeekStart);
    }
    
    // é€±ã‚’ç§»å‹•ã™ã‚‹
    function moveWeek(direction) {
      const currentStart = getCurrentWeekStart();
      const newWeekStart = new Date(currentStart);
      newWeekStart.setDate(currentStart.getDate() + (direction * 7));
      window.currentWeekStart = newWeekStart;
      loadCalendarEvents();
    }
    
    // ä»Šé€±ã«æˆ»ã‚‹
    function moveWeekToToday() {
      const today = new Date();
      window.currentWeekStart = getStartOfWeek(today);
      loadCalendarEvents();
    }
    
    // é€±è¡¨ç¤ºã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤º
    function displayWeekCalendar(data) {
      const weekViewContainer = document.getElementById('calendar-week-view');
      
      if (data.error) {
        weekViewContainer.innerHTML = '<div class="error">ã‚¨ãƒ©ãƒ¼: ' + data.message + '</div>';
        return;
      }
      
      if (!data.events || data.events.length === 0) {
        weekViewContainer.innerHTML = '<div class="loading">ã“ã®é€±ã®ä¼šè­°äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºç”¨ï¼‰
      window.calendarEventsData = data;
      
      // æ—¥ä»˜åˆ¤å®šç”¨ã®åŸºæº–æ—¥ã‚’è¨­å®š
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹é€±ã®é–‹å§‹æ—¥ã‚’å–å¾—
      const startOfWeek = getCurrentWeekStart();
      
      // é€±ã®æ—¥ä»˜é…åˆ—ã‚’ä½œæˆ
      const weekDays = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        weekDays.push(date);
      }
      
      // é€±ã®æƒ…å ±ã‚’è¡¨ç¤º
      const weekInfoElement = document.getElementById('calendar-week-info');
      const weekEndForDisplay = new Date(startOfWeek);
      weekEndForDisplay.setDate(startOfWeek.getDate() + 6);
      const weekInfoText = `${startOfWeek.getFullYear()}å¹´${startOfWeek.getMonth() + 1}æœˆ${startOfWeek.getDate()}æ—¥ ï½ ${weekEndForDisplay.getFullYear()}å¹´${weekEndForDisplay.getMonth() + 1}æœˆ${weekEndForDisplay.getDate()}æ—¥`;
      if (weekInfoElement) {
        weekInfoElement.textContent = weekInfoText;
      }
      
      // æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ6æ™‚ã€œ21æ™‚ï¼‰
      const timeSlots = [];
      for (let hour = 6; hour <= 21; hour++) {
        timeSlots.push(hour);
      }
      
      // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ—¥ä»˜ã¨æ™‚é–“ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const eventsByDay = {};
      weekDays.forEach((day, dayIndex) => {
        eventsByDay[dayIndex] = [];
      });
      
      data.events.forEach(event => {
        const startDate = new Date(event.startTime);
        const eventDay = new Date(startDate);
        eventDay.setHours(0, 0, 0, 0);
        
        // é€±ã®ã©ã®æ—¥ã‹ã‚’åˆ¤å®š
        const dayIndex = Math.floor((eventDay - startOfWeek) / (1000 * 60 * 60 * 24));
        if (dayIndex >= 0 && dayIndex < 7) {
          if (!eventsByDay[dayIndex]) {
            eventsByDay[dayIndex] = [];
          }
          eventsByDay[dayIndex].push(event);
        }
      });
      
      // HTMLã‚’ç”Ÿæˆ
      let html = '<div class="calendar-week-grid">';
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆæ™‚é–“åˆ— + æ›œæ—¥ï¼‰
      html += '<div class="calendar-week-header"></div>';
      weekDays.forEach(day => {
        const dayName = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][day.getDay()];
        const dayNum = day.getDate();
        const isToday = day.getTime() === today.getTime();
        html += `<div class="calendar-week-day-header ${isToday ? 'today' : ''}">${dayName}<br><span style="font-size: 1.5rem; font-weight: 800;">${dayNum}</span></div>`;
      });
      
      // æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆè¡Œ
      timeSlots.forEach(hour => {
        // æ™‚é–“åˆ—
        html += `<div class="calendar-week-time-slot">${hour}:00</div>`;
        
        // å„æ—¥ã®ã‚»ãƒ«
        weekDays.forEach((day, dayIndex) => {
          const dayEvents = eventsByDay[dayIndex] || [];
          const hourEvents = dayEvents.filter(event => {
            const eventStart = new Date(event.startTime);
            return eventStart.getHours() === hour;
          });
          
          html += '<div class="calendar-week-day-cell">';
          
          hourEvents.forEach(event => {
            const startDate = new Date(event.startTime);
            const endDate = new Date(event.endTime);
            
            const topPercent = (startDate.getMinutes() / 60) * 100;
            const heightPercent = ((endDate - startDate) / (1000 * 60 * 60)) * 100;
            
            // é™¤å¤–ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const isExcluded = data.excludedEventIds && data.excludedEventIds.includes(event.id);
            const excludeBtnClass = isExcluded ? 'excluded' : '';
            const excludeBtnText = isExcluded ? 'âœ“ è¨ˆç®—ã«å«ã‚ã‚‹' : 'ğŸ“Š é™¤å¤–';
            
            html += `
              <div class="calendar-week-event" 
                   style="top: ${topPercent}%; height: ${Math.max(heightPercent, 20)}%;"
                   onclick="showCalendarEventModal('${escapeHtml(event.id)}')"
                   title="${escapeHtml(event.title)}">
                ${escapeHtml(event.title)}
                <button class="calendar-week-event-exclude-btn ${excludeBtnClass}" 
                        onclick="event.stopPropagation(); toggleWorkloadExclusion('${escapeHtml(event.id)}', this)">
                  ${excludeBtnText}
                </button>
              </div>
            `;
          });
          
          html += '</div>';
        });
      });
      
      html += '</div>';
      weekViewContainer.innerHTML = html;
    }
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showCalendarEventModal(eventId) {
      if (!window.calendarEventsData || !window.calendarEventsData.events) {
        alert('ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      const event = window.calendarEventsData.events.find(e => e.id === eventId);
      if (!event) {
        alert('ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
      const startDate = new Date(event.startTime);
      const endDate = new Date(event.endTime);
      const dateStr = startDate.toLocaleDateString('ja-JP', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        weekday: 'short'
      });
      const timeStr = startDate.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) + 
                     ' - ' + 
                     endDate.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
      
      document.getElementById('calendar-event-modal-title').textContent = event.title;
      document.getElementById('calendar-event-modal-datetime').textContent = dateStr + ' ' + timeStr;
      document.getElementById('calendar-event-modal-location').textContent = event.location || 'ï¼ˆå ´æ‰€æœªè¨­å®šï¼‰';
      
      // èª¬æ˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯HTMLã¨ã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæ”¹è¡Œã‚¿ã‚°ãªã©ã‚’æœ‰åŠ¹åŒ–ï¼‰
      const descriptionElement = document.getElementById('calendar-event-modal-description');
      const description = event.description || 'ï¼ˆèª¬æ˜ãªã—ï¼‰';
      // åŸºæœ¬çš„ãªXSSå¯¾ç­–ï¼šå±é™ºãªã‚¿ã‚°ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¤ã¤ã€<br>ã¨<a>ã‚¿ã‚°ã¯è¨±å¯
      const sanitizedDescription = sanitizeHtml(description);
      descriptionElement.innerHTML = sanitizedDescription;
      
      document.getElementById('calendar-event-modal-duration').textContent = event.duration.toFixed(1) + 'æ™‚é–“';
      
      // é™¤å¤–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’è¨­å®š
      const excludeBtn = document.getElementById('calendar-event-modal-exclude-btn');
      const isExcluded = window.calendarEventsData.excludedEventIds && 
                        window.calendarEventsData.excludedEventIds.includes(eventId);
      
      if (isExcluded) {
        excludeBtn.textContent = 'âœ“ åŠ´åƒè² è·è¨ˆç®—ã«å«ã‚ã‚‹';
        excludeBtn.classList.add('excluded');
      } else {
        excludeBtn.textContent = 'ğŸ“Š åŠ´åƒè² è·è¨ˆç®—ã‹ã‚‰é™¤å¤–';
        excludeBtn.classList.remove('excluded');
      }
      
      excludeBtn.onclick = function() {
        toggleWorkloadExclusion(eventId, excludeBtn);
      };
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.getElementById('calendar-event-modal').style.display = 'block';
    }
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeCalendarEventModal() {
      document.getElementById('calendar-event-modal').style.display = 'none';
    }
    
    // displayCalendarEventsé–¢æ•°ã‚’ä¿®æ­£ã—ã¦ã€é€±è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
    const originalDisplayCalendarEvents = displayCalendarEvents;
    displayCalendarEvents = function(data) {
      // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      window.calendarEventsData = data;
      // é€±è¡¨ç¤ºã‚’æ›´æ–°
      displayWeekCalendar(data);
    };
    
    // ãƒãƒˆãƒªã‚¯ã‚¹å€¤ã‚’å„ªå…ˆåº¦ãƒ»é‡è¦åº¦ã«å¤‰æ›
    function parseMatrixValue(matrixValue) {
      const matrixMap = {
        'é«˜å„ªå…ˆ/é«˜é‡è¦': { priority: 'é«˜', importance: 'é«˜' },
        'é«˜å„ªå…ˆ/ä½é‡è¦': { priority: 'é«˜', importance: 'ä½' },
        'ä½å„ªå…ˆ/é«˜é‡è¦': { priority: 'ä½', importance: 'é«˜' },
        'ä½å„ªå…ˆ/ä½é‡è¦': { priority: 'ä½', importance: 'ä½' },
        // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã€æ—§å½¢å¼ã‚‚ã‚µãƒãƒ¼ãƒˆ
        'é«˜ç·Šæ€¥/é«˜é‡è¦': { priority: 'é«˜', importance: 'é«˜' },
        'é«˜ç·Šæ€¥/ä½é‡è¦': { priority: 'é«˜', importance: 'ä½' },
        'ä½ç·Šæ€¥/é«˜é‡è¦': { priority: 'ä½', importance: 'é«˜' },
        'ä½ç·Šæ€¥/ä½é‡è¦': { priority: 'ä½', importance: 'ä½' }
      };
      return matrixMap[matrixValue] || { priority: 'ä¸­', importance: 'ä¸­' };
    }
    
    // ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†
    document.getElementById('task-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const form = this;
      const submitButton = form.querySelector('button[type="submit"]');
      
      // ãƒãƒˆãƒªã‚¯ã‚¹å€¤ã‚’å„ªå…ˆåº¦ãƒ»é‡è¦åº¦ã«å¤‰æ›
      const matrixValue = document.getElementById('task-matrix').value;
      const { priority, importance } = parseMatrixValue(matrixValue);
      
      const formData = {
        title: document.getElementById('task-title').value,
        description: document.getElementById('task-description').value,
        estimatedHours: document.getElementById('task-hours').value,
        priority: priority,
        importance: importance,
        deliverable: document.getElementById('task-deliverable').value,
        deadline: document.getElementById('task-deadline').value,
        status: 'æœªç€æ‰‹'
      };
      
      callGasWithLoading(submitButton, function(enableButton) {
        return google.script.run
          .withSuccessHandler(function(result) {
            enableButton(); // å‡¦ç†å®Œäº†å¾Œã«å†æœ‰åŠ¹åŒ–
            if (result.error) {
              alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
            } else {
              alert('ã‚¿ã‚¹ã‚¯ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼');
              form.reset();
              loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            }
          })
          .withFailureHandler(function(error) {
            enableButton(); // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å†æœ‰åŠ¹åŒ–
            showError(error);
          })
          .addTask(formData);
      }, { loadingText: 'è¿½åŠ ä¸­...' });
    });
    
    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(error) {
      console.error('Error:', error);
      alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
    
    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // HTMLã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆæ”¹è¡Œã‚¿ã‚°ã¨ãƒªãƒ³ã‚¯ã‚¿ã‚°ã‚’è¨±å¯ï¼‰
    function sanitizeHtml(html) {
      if (!html) return '';
      
      // <br>ã‚¿ã‚°ã‚’æ”¹è¡Œã«å¤‰æ›
      let processed = html.replace(/<br\s*\/?>/gi, '\n');
      
      // <a>ã‚¿ã‚°ã‚’æŠ½å‡ºã—ã¦ä¿è­·
      const links = [];
      processed = processed.replace(/<a\s+href=["']([^"']+)["'][^>]*>([^<]*)<\/a>/gi, (match, href, text) => {
        const linkId = `__LINK_${links.length}__`;
        links.push({ id: linkId, href: href.trim(), text: text.trim() });
        return linkId;
      });
      
      // ã™ã¹ã¦ã®HTMLã‚¿ã‚°ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
      const div = document.createElement('div');
      div.textContent = processed;
      let sanitized = div.innerHTML;
      
      // ãƒªãƒ³ã‚¯ã‚’å¾©å…ƒï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æ¢ã™ï¼‰
      links.forEach(({ id, href, text }) => {
        const escapedId = escapeHtml(id);
        const safeLink = `<a href="${escapeHtml(href)}" target="_blank" rel="noopener noreferrer">${escapeHtml(text)}</a>`;
        sanitized = sanitized.replace(escapedId, safeLink);
      });
      
      // æ”¹è¡Œã‚’<br>ã«å¤‰æ›
      sanitized = sanitized.replace(/\n/g, '<br>');
      
      return sanitized;
    }
    
    // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆYYYY-MM-DDå½¢å¼ã‚’æ—¥æœ¬èªå½¢å¼ã«å¤‰æ›ï¼‰
    function formatDate(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
          // ISOå½¢å¼ã§ãªã„å ´åˆã¯ãã®ã¾ã¾è¿”ã™
          return dateString;
        }
        return date.toLocaleDateString('ja-JP', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      } catch (e) {
        return dateString;
      }
    }
    
    // ã‚¿ã‚¹ã‚¯ã®ç·¨é›†
    function editTask(taskId, buttonElement) {
      // æ—¢ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
      const modal = document.getElementById('edit-task-modal');
      if (modal.style.display === 'block') {
        return;
      }
      
      // ãƒœã‚¿ãƒ³ãŒæ—¢ã«ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
      if (buttonElement && buttonElement.disabled) {
        return;
      }
      
      // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      callGasWithLoading(buttonElement, function(enableButton) {
        const gasCall = google.script.run
          .withSuccessHandler(function(result) {
            enableButton(); // å‡¦ç†å®Œäº†å¾Œã«å†æœ‰åŠ¹åŒ–
            
            // JSONæ–‡å­—åˆ—ã®å ´åˆ
            let parsedResult = null;
            if (typeof result === 'string') {
              try {
                parsedResult = JSON.parse(result);
              } catch (parseError) {
                console.error('editTask: JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', parseError);
                alert('ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
                return;
              }
            } 
            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
            else if (result && typeof result === 'object' && !Array.isArray(result)) {
              parsedResult = result;
            }
            // é…åˆ—ã§ç›´æ¥è¿”ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
            else if (Array.isArray(result)) {
              parsedResult = { success: true, tasks: result };
            }
            // ãã®ä»–ã®å ´åˆ
            else {
              console.warn('editTask: äºˆæœŸã—ãªã„å½¢å¼:', result);
              alert('ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
              return;
            }
            
            // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
            if (parsedResult.error) {
              alert('ã‚¨ãƒ©ãƒ¼: ' + parsedResult.message);
              return;
            }
            
            // tasksé…åˆ—ã‚’å–å¾—
            let tasks = [];
            if (parsedResult.success && Array.isArray(parsedResult.tasks)) {
              tasks = parsedResult.tasks;
            } else if (Array.isArray(parsedResult)) {
              tasks = parsedResult;
            } else {
            console.warn('editTask: tasksé…åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', parsedResult);
            alert('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            return;
          }
            
            // é…åˆ—ãƒã‚§ãƒƒã‚¯
            if (!Array.isArray(tasks)) {
              console.error('editTask: tasksãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“:', tasks);
              alert('ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
              return;
            }
            
            const task = tasks.find(t => t.id === taskId);
            if (!task) {
              alert('ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              return;
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            document.getElementById('edit-task-id').value = task.id;
            document.getElementById('edit-task-title').value = task.title;
            document.getElementById('edit-task-description').value = task.description || '';
            document.getElementById('edit-task-hours').value = task.estimatedHours;
            
            // å„ªå…ˆåº¦ãƒ»é‡è¦åº¦ã‹ã‚‰ãƒãƒˆãƒªã‚¯ã‚¹å€¤ã‚’è¨ˆç®—
            const priority = task.priority || 'ä¸­';
            const importance = task.importance || 'ä¸­';
            let matrixValue = '';
            if (priority === 'é«˜' && importance === 'é«˜') {
              matrixValue = 'é«˜å„ªå…ˆ/é«˜é‡è¦';
            } else if (priority === 'é«˜' && importance === 'ä½') {
              matrixValue = 'é«˜å„ªå…ˆ/ä½é‡è¦';
            } else if (priority === 'ä½' && importance === 'é«˜') {
              matrixValue = 'ä½å„ªå…ˆ/é«˜é‡è¦';
            } else {
              matrixValue = 'ä½å„ªå…ˆ/ä½é‡è¦';
            }
            document.getElementById('edit-task-matrix').value = matrixValue;
            
            document.getElementById('edit-task-deliverable').value = task.deliverable || '';
            // ç· åˆ‡æ—¥ã‚’è¨­å®šï¼ˆISOå½¢å¼ã«å¤‰æ›ï¼‰
            if (task.deadline) {
              const deadlineDate = new Date(task.deadline);
              if (!isNaN(deadlineDate.getTime())) {
                document.getElementById('edit-task-deadline').value = deadlineDate.toISOString().split('T')[0];
              } else {
                document.getElementById('edit-task-deadline').value = task.deadline;
              }
            } else {
              document.getElementById('edit-task-deadline').value = '';
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            modal.style.display = 'block';
          })
          .withFailureHandler(function(error) {
            enableButton(); // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å†æœ‰åŠ¹åŒ–
            showError(error);
          })
          .getTasks();
        
        return gasCall;
      }, { loadingText: 'èª­ã¿è¾¼ã¿ä¸­...' });
    }
    
    // ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡
    document.getElementById('edit-task-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const form = this;
      const submitButton = form.querySelector('button[type="submit"]');
      
      const taskId = document.getElementById('edit-task-id').value;
      
      // ãƒãƒˆãƒªã‚¯ã‚¹å€¤ã‚’å„ªå…ˆåº¦ãƒ»é‡è¦åº¦ã«å¤‰æ›
      const matrixValue = document.getElementById('edit-task-matrix').value;
      const { priority, importance } = parseMatrixValue(matrixValue);
      
      const taskData = {
        title: document.getElementById('edit-task-title').value,
        description: document.getElementById('edit-task-description').value,
        estimatedHours: document.getElementById('edit-task-hours').value,
        priority: priority,
        importance: importance,
        deliverable: document.getElementById('edit-task-deliverable').value,
        deadline: document.getElementById('edit-task-deadline').value
      };
      
      callGasWithLoading(submitButton, function(enableButton) {
        return google.script.run
          .withSuccessHandler(function(result) {
            enableButton(); // å‡¦ç†å®Œäº†å¾Œã«å†æœ‰åŠ¹åŒ–
            if (result.error) {
              alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
            } else {
              alert('ã‚¿ã‚¹ã‚¯ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼');
              closeEditModal();
              loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            }
          })
          .withFailureHandler(function(error) {
            enableButton(); // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å†æœ‰åŠ¹åŒ–
            showError(error);
          })
          .updateTask(taskId, taskData);
      }, { loadingText: 'æ›´æ–°ä¸­...' });
    });
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeEditModal() {
      document.getElementById('edit-task-modal').style.display = 'none';
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.onclick = function(event) {
      const modal = document.getElementById('edit-task-modal');
      if (event.target === modal) {
        closeEditModal();
      }
    }
    
    // ã‚¿ã‚¹ã‚¯ã®å‰Šé™¤
    function deleteTask(taskId, buttonElement) {
      if (!confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }
      
      callGasWithLoading(buttonElement, function(enableButton) {
        return google.script.run
          .withSuccessHandler(function(result) {
            enableButton(); // å‡¦ç†å®Œäº†å¾Œã«å†æœ‰åŠ¹åŒ–
            if (result.error) {
              alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
            } else {
              alert('ã‚¿ã‚¹ã‚¯ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼');
              loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            }
          })
          .withFailureHandler(function(error) {
            enableButton(); // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å†æœ‰åŠ¹åŒ–
            showError(error);
          })
          .deleteTask(taskId);
      }, { loadingText: 'å‰Šé™¤ä¸­...' });
    }
    
    // ã‚¿ã‚¹ã‚¯ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    function updateTaskStatus(taskId, status, selectElement) {
      // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ç„¡åŠ¹åŒ–
      if (selectElement) {
        selectElement.disabled = true;
      }

      callGasWithLoading(null, function(enableButton) {
        return google.script.run
          .withSuccessHandler(function(result) {
            enableButton(); // å‡¦ç†å®Œäº†å¾Œã«å†æœ‰åŠ¹åŒ–ï¼ˆãƒœã‚¿ãƒ³ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼‰
            if (result.error) {
              alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
              loadTasks(); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å†èª­ã¿è¾¼ã¿
            } else {
              loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
              
              // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œå®Œäº†ã€ã«å¤‰æ›´ã•ã‚ŒãŸå ´åˆã€å®Œäº†ã‚¿ã‚¹ã‚¯ã‚’å†èª­ã¿è¾¼ã¿
              if (status === 'å®Œäº†') {
                const reportDateInput = document.getElementById('report-date');
                if (reportDateInput && reportDateInput.value) {
                  loadCompletedTasksToday(reportDateInput.value);
                }
              }
            }
            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’å†æœ‰åŠ¹åŒ–
            if (selectElement) {
              selectElement.disabled = false;
            }
          })
          .withFailureHandler(function(error) {
            enableButton(); // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å†æœ‰åŠ¹åŒ–
            showError(error);
            // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’å†æœ‰åŠ¹åŒ–
            if (selectElement) {
              selectElement.disabled = false;
            }
          })
          .updateTaskStatus(taskId, status);
      });
    }
    
    // æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã®ä½“èª¿ã‚¹ã‚³ã‚¢ã‚’é¸æŠ
    function selectReportHealthScore(score, button) {
      // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‹ã‚‰selectedã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      const form = document.getElementById('daily-report-form');
      form.querySelectorAll('.health-score-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // é¸æŠã—ãŸãƒœã‚¿ãƒ³ã«selectedã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      button.classList.add('selected');
      
      // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
      document.getElementById('report-health-score').value = score;
    }
    
    // ä»Šæ—¥å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã‚€
    function loadCompletedTasksToday(date) {
      const infoElement = document.getElementById('completed-tasks-info');
      if (!infoElement) return;
      
      callGasWithLoading(null, function(enableButton) {
        return google.script.run
          .withSuccessHandler(function(result) {
            enableButton();
            if (result.error) {
              infoElement.innerHTML = '<div class="error">ã‚¨ãƒ©ãƒ¼: ' + result.message + '</div>';
              return;
            }
            
            if (result.count === 0) {
              infoElement.innerHTML = '<div class="info">ä»Šæ—¥å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            } else {
              let html = '<div class="completed-tasks-summary">';
              html += '<div class="summary-item">å®Œäº†ã‚¿ã‚¹ã‚¯æ•°: <strong>' + result.count + 'ä»¶</strong></div>';
              html += '<div class="summary-item">å®Œäº†ã‚¿ã‚¹ã‚¯æ™‚é–“åˆè¨ˆ: <strong>' + result.totalHours + 'æ™‚é–“</strong></div>';
              if (result.tasks && result.tasks.length > 0) {
                html += '<ul class="completed-tasks-list">';
                result.tasks.forEach(function(task) {
                  html += '<li>' + task.title + ' (' + task.estimatedHours + 'æ™‚é–“)</li>';
                });
                html += '</ul>';
              }
              html += '</div>';
              infoElement.innerHTML = html;
            }
          })
          .withFailureHandler(function(error) {
            enableButton();
            infoElement.innerHTML = '<div class="error">ã‚¨ãƒ©ãƒ¼: ' + error + '</div>';
          })
          .getCompletedTasksToday(date);
      });
    }
    
    // æ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡
    document.getElementById('daily-report-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const form = this;
      const submitButton = form.querySelector('button[type="submit"]');
      
      const date = document.getElementById('report-date').value;
      if (!date) {
        alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const reportData = {
        date: date,
        goal: document.getElementById('report-goal').value,
        healthScore: document.getElementById('report-health-score').value,
        reflection: document.getElementById('report-reflection').value,
        tomorrowPlan: document.getElementById('report-tomorrow-plan').value
      };
      
      callGasWithLoading(submitButton, function(enableButton) {
        return google.script.run
          .withSuccessHandler(function(result) {
            enableButton();
            if (result.error) {
              alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
            } else {
              alert('æ—¥å ±ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸï¼');
              // å®Œäº†ã‚¿ã‚¹ã‚¯æƒ…å ±ã‚’å†èª­ã¿è¾¼ã¿
              loadCompletedTasksToday(date);
            }
          })
          .withFailureHandler(function(error) {
            enableButton();
            showError(error);
          })
          .recordDailyReport(reportData);
      }, { loadingText: 'é€ä¿¡ä¸­...' });
    });
    
    // æ—¥ä»˜ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«å®Œäº†ã‚¿ã‚¹ã‚¯ã‚’å†èª­ã¿è¾¼ã¿
    document.getElementById('report-date').addEventListener('change', function() {
      const date = this.value;
      if (date) {
        loadCompletedTasksToday(date);
        // æ—¥å ±ãƒ‡ãƒ¼ã‚¿ã‚‚èª­ã¿è¾¼ã‚€
        loadDailyReport(date);
      }
    });
    
    // æ—¥å ±ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    function loadDailyReport(date) {
      callGasWithLoading(null, function(enableButton) {
        return google.script.run
          .withSuccessHandler(function(report) {
            enableButton();
            if (report.error) {
              // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆæ—¥å ±ãŒæœªä½œæˆã®å ´åˆã‚‚ã‚ã‚‹ï¼‰
              return;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            document.getElementById('report-goal').value = report.goal || '';
            document.getElementById('report-reflection').value = report.reflection || '';
            document.getElementById('report-tomorrow-plan').value = report.tomorrowPlan || '';
            
            // é€€ç¤¾æ™‚ä½“èª¿ã‚¹ã‚³ã‚¢ã‚’è¨­å®šï¼ˆæ—¥å ±ãƒ•ã‚©ãƒ¼ãƒ å†…ï¼‰
            if (report.healthScore) {
              const button = document.querySelector('#daily-report-form .health-score-btn[data-score="' + report.healthScore + '"]');
              if (button) {
                selectReportHealthScore(report.healthScore, button);
              }
            }
          })
          .withFailureHandler(function(error) {
            enableButton();
            // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
          })
          .getDailyReport(date);
      });
    }
  </script>
</body>
</html>


